**********************
Inicio de la transcripción de Windows PowerShell
Hora de inicio: 20240927124335
Nombre de usuario: UPCN\nechegoyen
Usuario RunAs: UPCN\nechegoyen
Nombre de la configuración: 
Máquina: SYS-NESTOR2 (Microsoft Windows NT 10.0.22631.0)
Aplicación host: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
Id. de proceso: 25792
PSVersion: 5.1.22621.4249
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.22621.4249
BuildVersion: 10.0.22621.4249
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
La transcripción ha comenzado. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
2024-09-27 12:43:35 - Iniciando proceso de exportaciÃ³n...
2024-09-27 12:43:35 - Conectado al servidor SQL 192.168.0.230 y a la base de datos UPCN_REPORTES correctamente.

2024-09-27 12:43:35 - Cambios preparados para Git.
[main 35b1135] ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:43:35
 3 files changed, 117 insertions(+), 6 deletions(-)
 create mode 100644 transcript_log.txt
2024-09-27 12:43:35 - Commit realizado con el mensaje: 'ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:43:35'
Enumerating objects: 8, done.
Counting objects: 100% (8/8), done.
Delta compression using up to 28 threads
Compressing objects: 100% (5/5), done.
Writing objects: 100% (5/5), 1.29 KiB | 1.29 MiB/s, done.
Total 5 (delta 2), reused 0 (delta 0), pack-reused 0 (from 0)
remote: Resolving deltas: 100% (2/2), completed with 2 local objects.
To https://github.com/UPCN-Nestor/reportes-sql.git
   7b7e8a6..35b1135  main -> main
2024-09-27 12:43:37 - Cambios subidos al repositorio remoto.
2024-09-27 12:43:37 - Proceso de exportaciÃ³n y Git finalizado.
**********************
Fin de la transcripción de Windows PowerShell
Hora de finalización: 20240927124337
**********************
**********************
Inicio de la transcripción de Windows PowerShell
Hora de inicio: 20240927124616
Nombre de usuario: UPCN\nechegoyen
Usuario RunAs: UPCN\nechegoyen
Nombre de la configuración: 
Máquina: SYS-NESTOR2 (Microsoft Windows NT 10.0.22631.0)
Aplicación host: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
Id. de proceso: 25792
PSVersion: 5.1.22621.4249
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.22621.4249
BuildVersion: 10.0.22621.4249
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
La transcripción ha comenzado. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
2024-09-27 12:46:16 - Iniciando proceso de exportaciÃ³n...
2024-09-27 12:46:16 - Conectado al servidor SQL 192.168.0.230 y a la base de datos UPCN_REPORTES correctamente.
2024-09-27 12:46:16 - NÃºmero de vistas encontradas: 0

2024-09-27 12:46:16 - Cambios preparados para Git.
[main 6442b44] ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:46:16
 3 files changed, 27 insertions(+), 261 deletions(-)
 delete mode 100644 log.txt
2024-09-27 12:46:16 - Commit realizado con el mensaje: 'ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:46:16'
Enumerating objects: 7, done.
Counting objects: 100% (7/7), done.
Delta compression using up to 28 threads
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 1.39 KiB | 1.39 MiB/s, done.
Total 4 (delta 1), reused 0 (delta 0), pack-reused 0 (from 0)
remote: Resolving deltas: 100% (1/1), completed with 1 local object.
To https://github.com/UPCN-Nestor/reportes-sql.git
   35b1135..6442b44  main -> main
2024-09-27 12:46:18 - Cambios subidos al repositorio remoto.
2024-09-27 12:46:18 - Proceso de exportaciÃ³n y Git finalizado.
**********************
Fin de la transcripción de Windows PowerShell
Hora de finalización: 20240927124618
**********************
**********************
Inicio de la transcripción de Windows PowerShell
Hora de inicio: 20240927124837
Nombre de usuario: UPCN\nechegoyen
Usuario RunAs: UPCN\nechegoyen
Nombre de la configuración: 
Máquina: SYS-NESTOR2 (Microsoft Windows NT 10.0.22631.0)
Aplicación host: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
Id. de proceso: 25792
PSVersion: 5.1.22621.4249
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.22621.4249
BuildVersion: 10.0.22621.4249
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
La transcripción ha comenzado. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
2024-09-27 12:48:37 - Iniciando proceso de exportaciÃ³n...
2024-09-27 12:48:37 - Conectado al servidor SQL 192.168.0.230 y a la base de datos UPCN_REPORTES correctamente.
2024-09-27 12:48:37 - NÃºmero de vistas encontradas: 0

2024-09-27 12:48:37 - Cambios preparados para Git.
[main 2b375e3] ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:48:37
 2 files changed, 44 insertions(+), 1 deletion(-)
2024-09-27 12:48:37 - Commit realizado con el mensaje: 'ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:48:37'
Enumerating objects: 7, done.
Counting objects: 100% (7/7), done.
Delta compression using up to 28 threads
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 1.48 KiB | 1.48 MiB/s, done.
Total 4 (delta 1), reused 0 (delta 0), pack-reused 0 (from 0)
remote: Resolving deltas: 100% (1/1), completed with 1 local object.
To https://github.com/UPCN-Nestor/reportes-sql.git
   6442b44..2b375e3  main -> main
2024-09-27 12:48:39 - Cambios subidos al repositorio remoto.
2024-09-27 12:48:39 - Proceso de exportaciÃ³n y Git finalizado.
**********************
Fin de la transcripción de Windows PowerShell
Hora de finalización: 20240927124839
**********************
**********************
Inicio de la transcripción de Windows PowerShell
Hora de inicio: 20240927125255
Nombre de usuario: UPCN\nechegoyen
Usuario RunAs: UPCN\nechegoyen
Nombre de la configuración: 
Máquina: SYS-NESTOR2 (Microsoft Windows NT 10.0.22631.0)
Aplicación host: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
Id. de proceso: 25792
PSVersion: 5.1.22621.4249
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.22621.4249
BuildVersion: 10.0.22621.4249
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
La transcripción ha comenzado. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
2024-09-27 12:52:55 - Iniciando proceso de exportaciÃ³n...
2024-09-27 12:52:55 - Conectado al servidor SQL 192.168.0.230 y a la base de datos UPCN_REPORTES correctamente.
2024-09-27 12:52:55 - NÃºmero de vistas encontradas en el esquema dbo: 0
2024-09-27 12:52:55 - NÃºmero de funciones encontradas en el esquema dbo: 0

2024-09-27 12:52:55 - Cambios preparados para Git.
[main 55cdcd8] ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:52:55
 2 files changed, 53 insertions(+), 8 deletions(-)
2024-09-27 12:52:55 - Commit realizado con el mensaje: 'ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:52:55'
Enumerating objects: 7, done.
Counting objects: 100% (7/7), done.
Delta compression using up to 28 threads
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 755 bytes | 755.00 KiB/s, done.
Total 4 (delta 2), reused 0 (delta 0), pack-reused 0 (from 0)
remote: Resolving deltas: 100% (2/2), completed with 2 local objects.
To https://github.com/UPCN-Nestor/reportes-sql.git
   2b375e3..55cdcd8  main -> main
2024-09-27 12:52:57 - Cambios subidos al repositorio remoto.
2024-09-27 12:52:57 - Proceso de exportaciÃ³n y Git finalizado.
**********************
Fin de la transcripción de Windows PowerShell
Hora de finalización: 20240927125257
**********************
**********************
Inicio de la transcripción de Windows PowerShell
Hora de inicio: 20240927125357
Nombre de usuario: UPCN\nechegoyen
Usuario RunAs: UPCN\nechegoyen
Nombre de la configuración: 
Máquina: SYS-NESTOR2 (Microsoft Windows NT 10.0.22631.0)
Aplicación host: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
Id. de proceso: 25792
PSVersion: 5.1.22621.4249
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.22621.4249
BuildVersion: 10.0.22621.4249
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
La transcripción ha comenzado. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
2024-09-27 12:53:57 - Iniciando proceso de exportaciÃ³n...
2024-09-27 12:53:57 - Conectado al servidor SQL 192.168.0.230 y a la base de datos UPCN_REPORTES correctamente.
2024-09-27 12:53:57 - NÃºmero de vistas encontradas en el esquema dbo: 0
2024-09-27 12:53:57 - NÃºmero de funciones encontradas en el esquema dbo: 0

2024-09-27 12:53:57 - Cambios preparados para Git.
[main 30701f4] ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:53:57
 2 files changed, 45 insertions(+), 2 deletions(-)
2024-09-27 12:53:57 - Commit realizado con el mensaje: 'ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:53:57'
Enumerating objects: 7, done.
Counting objects: 100% (7/7), done.
Delta compression using up to 28 threads
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 703 bytes | 703.00 KiB/s, done.
Total 4 (delta 2), reused 0 (delta 0), pack-reused 0 (from 0)
remote: Resolving deltas: 100% (2/2), completed with 2 local objects.
To https://github.com/UPCN-Nestor/reportes-sql.git
   55cdcd8..30701f4  main -> main
2024-09-27 12:53:59 - Cambios subidos al repositorio remoto.
2024-09-27 12:53:59 - Proceso de exportaciÃ³n y Git finalizado.
**********************
Fin de la transcripción de Windows PowerShell
Hora de finalización: 20240927125359
**********************
**********************
Inicio de la transcripción de Windows PowerShell
Hora de inicio: 20240927125841
Nombre de usuario: UPCN\nechegoyen
Usuario RunAs: UPCN\nechegoyen
Nombre de la configuración: 
Máquina: SYS-NESTOR2 (Microsoft Windows NT 10.0.22631.0)
Aplicación host: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
Id. de proceso: 25792
PSVersion: 5.1.22621.4249
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.22621.4249
BuildVersion: 10.0.22621.4249
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
La transcripción ha comenzado. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
2024-09-27 12:58:41 - Iniciando proceso de exportaciÃ³n...
Invoke-Sqlcmd : A network-related or instance-specific error occurred while establishing a connection to SQL Server. 
The server was not found or was not accessible. Verify that the instance name is correct and that SQL Server is 
configured to allow remote connections. (provider: SQL Network Interfaces, error: 26 - Error Locating Server/Instance 
Specified)
En C:\Repos\reportes-sql\backup-scripts-vistas.ps1: 51 Carácter: 15
+ ...    $vistas = Invoke-Sqlcmd @parametrosConexion -Query $consultaVistas
+                  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (:) [Invoke-Sqlcmd], SqlException
    + FullyQualifiedErrorId : SqlExceptionError,Microsoft.SqlServer.Management.PowerShell.GetScriptCommand
Invoke-Sqlcmd : A network-related or instance-specific error occurred while establishing a connection to SQL Server. The server was not found or was not accessible. Verify that the instance name is correct and that SQL Server is
configured to allow remote connections. (provider: SQL Network Interfaces, error: 26 - Error Locating Server/Instance Specified)
En C:\Repos\reportes-sql\backup-scripts-vistas.ps1: 51 Carácter: 15
+ ...    $vistas = Invoke-Sqlcmd @parametrosConexion -Query $consultaVistas
+                  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (:) [Invoke-Sqlcmd], SqlException
    + FullyQualifiedErrorId : SqlExceptionError,Microsoft.SqlServer.Management.PowerShell.GetScriptCommand

>> ErrorTerminación(Invoke-Sqlcmd): "Se encontró un sintaxis incorrecta al analizar ''."
2024-09-27 12:58:55 - Error al exportar vistas: Se encontró un sintaxis incorrecta al analizar ''.
Invoke-Sqlcmd : A network-related or instance-specific error occurred while establishing a connection to SQL Server. 
The server was not found or was not accessible. Verify that the instance name is correct and that SQL Server is 
configured to allow remote connections. (provider: SQL Network Interfaces, error: 26 - Error Locating Server/Instance 
Specified)
En C:\Repos\reportes-sql\backup-scripts-vistas.ps1: 83 Carácter: 18
+ ... funciones = Invoke-Sqlcmd @parametrosConexion -Query $consultaFuncion ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (:) [Invoke-Sqlcmd], SqlException
    + FullyQualifiedErrorId : SqlExceptionError,Microsoft.SqlServer.Management.PowerShell.GetScriptCommand
Invoke-Sqlcmd : A network-related or instance-specific error occurred while establishing a connection to SQL Server. The server was not found or was not accessible. Verify that the instance name is correct and that SQL Server is
configured to allow remote connections. (provider: SQL Network Interfaces, error: 26 - Error Locating Server/Instance Specified)
En C:\Repos\reportes-sql\backup-scripts-vistas.ps1: 83 Carácter: 18
+ ... funciones = Invoke-Sqlcmd @parametrosConexion -Query $consultaFuncion ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (:) [Invoke-Sqlcmd], SqlException
    + FullyQualifiedErrorId : SqlExceptionError,Microsoft.SqlServer.Management.PowerShell.GetScriptCommand

>> ErrorTerminación(Invoke-Sqlcmd): "Se encontró un sintaxis incorrecta al analizar ''."
2024-09-27 12:58:55 - Error al exportar funciones: Se encontró un sintaxis incorrecta al analizar ''.

2024-09-27 12:58:55 - Cambios preparados para Git.
[main 3cf0596] ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:58:55
 2 files changed, 108 insertions(+), 41 deletions(-)
2024-09-27 12:58:55 - Commit realizado con el mensaje: 'ActualizaciÃ³n de vistas y funciones - 2024-09-27 12:58:55'
Enumerating objects: 7, done.
Counting objects: 100% (7/7), done.
Delta compression using up to 28 threads
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 1.42 KiB | 1.42 MiB/s, done.
Total 4 (delta 2), reused 0 (delta 0), pack-reused 0 (from 0)
remote: Resolving deltas: 100% (2/2), completed with 2 local objects.
To https://github.com/UPCN-Nestor/reportes-sql.git
   30701f4..3cf0596  main -> main
2024-09-27 12:58:57 - Cambios subidos al repositorio remoto.
2024-09-27 12:58:57 - Proceso de exportaciÃ³n y Git finalizado.
**********************
Fin de la transcripción de Windows PowerShell
Hora de finalización: 20240927125857
**********************
**********************
Inicio de la transcripción de Windows PowerShell
Hora de inicio: 20240927130148
Nombre de usuario: UPCN\nechegoyen
Usuario RunAs: UPCN\nechegoyen
Nombre de la configuración: 
Máquina: SYS-NESTOR2 (Microsoft Windows NT 10.0.22631.0)
Aplicación host: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
Id. de proceso: 25792
PSVersion: 5.1.22621.4249
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.22621.4249
BuildVersion: 10.0.22621.4249
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
La transcripción ha comenzado. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
2024-09-27 13:01:49 - Iniciando proceso de exportaciÃ³n...
Import-Module : No se cargó el módulo 'sqlps' especificado porque no se encontró ningún archivo de módulo válido en 
ningún directorio de módulo.
En C:\Repos\reportes-sql\backup-scripts-vistas.ps1: 25 Carácter: 1
+ Import-Module "sqlps" -DisableNameChecking
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (sqlps:String) [Import-Module], FileNotFoundException
    + FullyQualifiedErrorId : Modules_ModuleNotFound,Microsoft.PowerShell.Commands.ImportModuleCommand
Import-Module : No se cargó el módulo 'sqlps' especificado porque no se encontró ningún archivo de módulo válido en ningún directorio de módulo.
En C:\Repos\reportes-sql\backup-scripts-vistas.ps1: 25 Carácter: 1
+ Import-Module "sqlps" -DisableNameChecking
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (sqlps:String) [Import-Module], FileNotFoundException
    + FullyQualifiedErrorId : Modules_ModuleNotFound,Microsoft.PowerShell.Commands.ImportModuleCommand

2024-09-27 13:01:49 - Conectado al servidor SQL 192.168.0.230 y a la base de datos UPCN_REPORTES correctamente.
2024-09-27 13:01:50 - NÃºmero de vistas encontradas: 12
2024-09-27 13:01:52 - Error al exportar vistas: Excepción al llamar a "Script" con los argumentos "1": "No se puede incluir Vista '[dbo].[ConsumosEnCero]' en el script porque sus datos no son accesibles."
PS>ErrorTerminación(): "Se ha detenido la canalización."
>> ErrorTerminación(): "Se ha detenido la canalización."
>> ErrorTerminación(): "Se ha detenido la canalización."
PS C:\Repos\reportes-sql> .\backup-scripts-vistas.ps1
La transcripción ha comenzado. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
2024-09-27 13:04:23 - Iniciando proceso de exportaciÃ³n...
2024-09-27 13:04:23 - Conectado al servidor SQL 192.168.0.230 y a la base de datos UPCN_REPORTES correctamente.
2024-09-27 13:04:24 - NÃºmero de vistas encontradas: 12
/****** Object:  View [dbo].[ConsumosEnCero]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
CREATE VIEW ConsumosEnCero AS
SELECT XX.*,
    C2.CnsKwAct UltLectura
FROM (SELECT Socio,
             Suministro,
             STRING_AGG(Medidor, ', ')                                                          Medidores,
             SUM(Consumo)                                                                       Consumo,
             CTA.SumNomPos                                                                      Nombre,
             CONCAT(TRIM(INM.InmCllDsc), ' ', INM.InmAlt , ' ', INM.InmPis, ' ', REPLACE(INM.InmDto, '"','')) Domicilio,
             MAX(FechaUltimaToma) FechaUltimaToma,
			 INM.InmLatitud Lat,
			 INM.InmLongitud Lon,
			 Area
      FROM (SELECT C.CliCod                             Socio,
                   C.SumNro                             Suministro,
                   CONCAT(CO.CnsTpoMdd, '-', CO.CnsMdd) Medidor,
                   SUM(CO.CnsKwCns)                     Consumo,
                   MAX(CnsFec)                          FechaUltimaToma,
				   C.Sum2Are Area				  
            FROM [UPCN_COM_PROD].dbo.CONSUM CO
                     JOIN [UPCN_COM_PROD].dbo.CONTRATO C
                          ON (CO.CnsSuc = C.SucCod AND CO.CliCod = C.CliCod AND CO.SumNro = C.SumNro AND
                              CO.CnsSrv = C.SrvCod)
            WHERE CO.CnsSuc = 1
              AND C.Sum2Sts IN (1, 2)
              AND C.CliCod <> 1100
              AND CO.CnsSrv = 1
              AND CO.CnsFec > '01/01/2024'
            GROUP BY C.CliCod, C.SumNro, CO.CnsTpoMdd, CO.CnsMdd, C.Sum2Are
            ) X
               JOIN [UPCN_COM_PROD].dbo.CUENTA CTA ON (X.Socio = CTA.CliCod AND X.Suministro = CTA.SumNro AND CTA.SucCod = 1)
               JOIN [UPCN_COM_PROD].dbo.INMUEBLE INM ON (CTA.SucCod = INM.SucCod AND CTA.InmCod = INM.InmCod)
      GROUP BY Socio, Suministro, CTA.SumNomPos, INM.InmCllDsc, INM.InmAlt, INM.InmPis, INM.InmDto, INM.InmLatitud, INM.InmLongitud, Area
      HAVING SUM(Consumo) < 20
    ) XX
    JOIN [UPCN_COM_PROD].dbo.CONSUM C2 ON (C2.CnsSuc = 1 AND C2.CnsSrv = 1 AND XX.Socio = C2.CliCod AND XX.Suministro = C2.SumNro AND XX.FechaUltimaToma = C2.CnsFec)
2024-09-27 13:04:24 - Vista exportada: dbo.ConsumosEnCero
/****** Object:  View [dbo].[Geo]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON



CREATE VIEW Geo AS
select c.CliCod Socio, c.SumNro Suministro, CONCAT(c.CliCod, '-', c.SumNro) "Soc-Sumi",
	i.InmLatitud Latitud, i.InmLongitud Longitud
from [UPCN_COM_PROD].dbo.[CUENTA] c
	join [UPCN_COM_PROD].dbo.[INMUEBLE] i
		on (c.SucCod = i.SucCod and c.InmCod = i.InmCod)
2024-09-27 13:04:24 - Vista exportada: dbo.Geo
/****** Object:  View [dbo].[ReporteCobranza]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON






/* COBRANZAS (Recaudacion Mensual) */

/* DROP VIEW ReporteCobranza */
CREATE VIEW [dbo].[ReporteCobranza] AS
SELECT CAST('01/' + RIGHT('00' + CAST(MONTH(P2.Pa1Fec) AS VARCHAR), 2) + '/' + CAST(YEAR(P2.Pa1Fec) AS VARCHAR) AS DATE) AS Periodo,
       CASE WHEN (P6.Pa6Ent = '9999') THEN 'cj. CHEQUE' 
		        WHEN (P6.Pa6Ent = 'EFEC') THEN 'cj. EFECTIVO' 
				WHEN (P6.Pa6Ent = '1036') THEN 'cj. DEBITO'
				WHEN (P6.Pa6Ent = '9001' OR P6.Pa6Ent = '9002' OR P6.Pa6Ent = '9852' OR P6.Pa6Ent = '9854') THEN 'z. TRANSFERENCIA'
				WHEN (P6.Pa6Ent = '9600' OR P6.Pa6Ent = '9650' OR P6.Pa6Ent = 'EPAN') THEN 'PREPAGO'
				WHEN (P6.Pa6Ent = '9750' OR P6.Pa6Ent = '9760' OR P6.Pa6Ent = '9761') THEN 'OFICINA VIRTUAL'
				WHEN (P6.Pa6Ent = '1040') THEN 'MUNICIPALIDAD'
				WHEN (P6.Pa6Ent = '9060') THEN 'COMPENSACIÓN'
				WHEN (P6.Pa6Ent = '9100') THEN 'PAGO FACIL'
				WHEN (P6.Pa6Ent = '9400') THEN 'RED LINK'
				WHEN (P6.Pa6Ent = '9300') THEN 'BAPRO'
				WHEN (P6.Pa6Ent = '9450') THEN 'BANELCO'
				WHEN (P6.Pa6Ent = '9200') THEN 'RIPSA'
				WHEN (P6.Pa6Ent = '9800') THEN 'COBROEXPRESS'
				WHEN (P6.Pa6Ent = '9900') THEN 'RAPIPAGO'
				WHEN (P6.Pa6Ent = '9001') THEN 'BCO. PCIA.'
				WHEN (P6.Pa6Ent = '9500') THEN 'BCO. MACRO'
				WHEN (P6.Pa6Ent = '9007') THEN 'BCO. RÍO'
				WHEN (P6.Pa6Ent = '9853') THEN 'BCO. RÍO TRANSF.'
				WHEN (P6.Pa6Ent = '9851') THEN 'BCO. PCIA. TRANSF.'
				WHEN (P6.Pa6Ent = '9700') THEN 'PRONTO PAGO'
				WHEN (P6.Pa6Ent = '9950') THEN 'COOP. CRÉDITO'
				WHEN (P6.Pa6Ent = '9000') THEN 'BCO. NACIÓN'
				ELSE 'OTROS'
		   END AS Ente,
		   CASE WHEN (P6.Pa6Ent = '9999') OR (P6.Pa6Ent = 'EFEC') OR (P6.Pa6Ent = '1036') THEN 'CAJAS'
				WHEN (P6.Pa6Ent = '9001' OR P6.Pa6Ent = '9002' OR P6.Pa6Ent = '9852' OR P6.Pa6Ent = '9854')  THEN 'z. TRANSFERENCIA'
				WHEN (P6.Pa6Ent = '9600' OR P6.Pa6Ent = '9650' OR P6.Pa6Ent = 'EPAN') THEN 'PREPAGO'
				WHEN (P6.Pa6Ent = '9750' OR P6.Pa6Ent = '9760' OR P6.Pa6Ent = '9761') THEN 'WEB'
				WHEN (P6.Pa6Ent = '1040') THEN 'MUNICIPALIDAD'
				WHEN (P6.Pa6Ent = '9060') THEN 'COMPENSACIÓN'
				WHEN (P6.Pa6Ent = '9400') OR (P6.Pa6Ent = '9450') THEN 'BANCA ELECTRÓNICA'
				WHEN (P6.Pa6Ent = '9300') OR (P6.Pa6Ent = '9200') OR (P6.Pa6Ent = '9800') OR (P6.Pa6Ent = '9900') OR (P6.Pa6Ent = '9100') OR (P6.Pa6Ent = '9001' OR P6.Pa6Ent = '9500' OR P6.Pa6Ent = '9007' OR P6.Pa6Ent = '9853' OR P6.Pa6Ent = '9851' 
						OR P6.Pa6Ent = '9700' OR P6.Pa6Ent = '9950' OR P6.Pa6Ent = '9000' 
				) THEN 'BANCO'
				ELSE 'OTROS' 
		   END AS Grupo,
		   P6.Pa6Ent AS "Código Ente",
		   P6.Pa6Imp AS Importe,
		   P2.Pa1Fec AS Fecha,
		   P2.Pa1Cjr AS Cajero,
		   P2.Pa2Rec AS Recibo,
		   P6.Pa6Cta AS Cuenta
FROM UPCN_COM_PROD.dbo.PAGAD2 P2 JOIN UPCN_COM_PROD.dbo.PAGAD6 P6 ON (P2.SucCod = P6.SucCod AND P2.Pa1Fec = P6.Pa1Fec AND P2.Pa1Cjr = P6.Pa1Cjr AND P2.Pa2Rec = P6.Pa2Rec)
WHERE P2.SucCod = 1 AND P2.Pa1Fec > '01/01/2019'
2024-09-27 13:04:24 - Vista exportada: dbo.ReporteCobranza
/****** Object:  View [dbo].[ReporteCuotaCapital]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON

/* drop VIEW ReporteCuotaCapital */
CREATE VIEW ReporteCuotaCapital AS
select YEAR(Fecha) Año, MONTH(Fecha) Mes, Caso,
	SUM(SaldoCC) SaldoCC, SUM(SaldoE) SaldoE,
	SUM(ImporteCC) ImporteCC, SUM(ImporteE) ImporteE,
	COUNT(*) Cantidad
from
(
	select FC.FactFec Fecha, CS.CompSdo SaldoCC, CS2.CompSdo SaldoE,
		CASE WHEN CS.CompSdo IS NULL and CS2.CompSdo IS NULL THEN 'Ambas Pagas'
			WHEN CS.CompSdo IS NOT NULL and CS2.CompSdo IS NULL THEN 'CC Impaga'
			WHEN CS.CompSdo IS NULL and CS2.CompSdo IS NOT NULL THEN 'Energía Impaga'
			WHEN CS.CompSdo IS NOT NULL and CS2.CompSdo IS NOT NULL THEN 'Ambas Impagas'
		END Caso,
		FE.Fac7NoEImp ImporteCC, FE.Fac7EneImp ImporteE
	from UPCN_COM_PROD.dbo.FACTUC FC
		join UPCN_COM_PROD.dbo.FACTUE FE ON (FC.SucCod = FE.SucCod and FC.CliCod = FE.CliCod and FC.SumNro = FE.SumNro 
			and FC.FrmCod = FE.FrmCod and FC.FactLet = FE.FactLet and FC.FactPtoV = FE.FactPtoV and FC.FactNro = FE.FactNro)
		left join UPCN_COM_PROD.dbo.COMSAL CS on (FC.SucCod = CS.SucCod and FC.CliCod = CS.CliCod and FC.SumNro = CS.SumNro
			and FC.FrmCod = CS.CompTpo and FC.FactLet = CS.CompLet and FC.FactPtoV = CS.CompPtoV and FC.FactNro = CS.CompNro)
		left join UPCN_COM_PROD.dbo.COMSAL CS2 ON (FE.SucCod = CS2.SucCod and FE.CliCod = CS2.CliCod and FE.SumNro = CS2.SumNro
			and FE.Fac7EneFrm = CS2.CompTpo and FE.Fac7EneLet = CS2.CompLet and FE.Fac7EnePto = CS2.CompPtoV and FE.Fac7EneNro = CS2.CompNro)		
	where FC.SucCod = 1 and FC.FactPtoV = 14
		and FC.FactFec > '01/01/2022'
		and FC.FactVto1 < GETDATE()
		and FC.FactFec IS NOT NULL
) x
group by YEAR(Fecha), MONTH(Fecha), Caso
2024-09-27 13:04:24 - Vista exportada: dbo.ReporteCuotaCapital
/****** Object:  View [dbo].[ReporteDeuda]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON




/* drop view [dbo].[ReporteDeuda] */
create view [dbo].[ReporteDeuda] as

SELECT CS.CliCod as Socio,
	CS.SumNro as Suministro,
	CONCAT(CS.CliCod, '-',CS.SumNro) as "Soc-Sumi",
	P.CliApe as Nombre,
	FS.Fac1EttCod as Tarifa,
	FS.Fac1Srv as ServicioPrincipal,
	FS.Fac1Are as Area,
	CompTpo as TipoComprobante,
	CONCAT(CompTpo, '-', CompLet, '-', CompPtoV, '-', CompNro) as Comprobante,
	CompFec as Emision,
	CompVto1 as Vencimiento,
	YEAR(CompVto1) AS VencimientoAño,
	CONCAT(YEAR(CompVto1), '-', MONTH(CompVto1)) AS VencimientoAñoMes,
	CASE WHEN CompVto1 > GETDATE() THEN 'N' ELSE 'S' END Vencida,
	CASE WHEN CompTpo IN (1,3) THEN CompImp WHEN CompTpo IN (50,60) THEN CompImp * -1 END AS Saldo,
	CO.Sum2Sts Estado,
	CASE WHEN CO.Sum2Sts = 4 THEN 'Desconectado' ELSE 'Conectado' END EstadoCD,
	Sum2FecSts FechaEstado,
	CASE WHEN CompEnerSN = 'N' THEN 'No energético' ELSE 'Energético' END Energetico
FROM [UPCN_COM_PROD].dbo.COMSAL CS
	OUTER APPLY (SELECT TOP(1) CliApe FROM [UPCN_COM_PROD].dbo.PERSONA P WHERE CS.SucCod = P.SucCod and CS.CliCod = P.CliCod) P
	OUTER APPLY (SELECT TOP(1) * FROM [UPCN_COM_PROD].dbo.CONTRATO CO WHERE CS.SucCod = CO.SucCod AND CS.CliCod = CO.CliCod AND CS.SumNro = CO.SumNro 
		ORDER BY CO.SrvCod) CO
	OUTER APPLY (SELECT TOP(1) FS.Fac1EttCod, FS.Fac1Srv, FS.Fac1Are 
		FROM [UPCN_COM_PROD].dbo.FACTUS FS 
		WHERE CS.SucCod = FS.SucCod  AND CS.CliCod = FS.CliCod AND CS.SumNro = FS.SumNro AND CS.CompFec = FS.FactFec AND CS.CompTpo = FS.FrmCod 
			AND CS.CompLet = FS.FactLet AND CS.CompPtoV = FS.FactPtoV AND CS.CompNro = FS.FactNro 
		ORDER BY FS.Fac1Srv
	) FS
WHERE CS.SucCod = 1 AND CS.CliCod <> 1100  
	AND CS.CompPtoV IN (0,12,13,14) -- Hay deuda rara en pto.vta. 8
	AND CS.CompVto1 > '01/01/2022'
2024-09-27 13:04:24 - Vista exportada: dbo.ReporteDeuda
/****** Object:  View [dbo].[ReporteFacturacion-bak]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON




/* drop view ReporteFacturacion */
CREATE VIEW [dbo].[ReporteFacturacion-bak] AS
SELECT 
	FC.CliCod as Socio,
	FC.SumNro as Suministro,
	FC.FrmCod as TipoComprobante,
	CONCAT(FC.FrmCod, '-', FC.FactLet, '-', FC.FactPtoV, '-', FC.FactNro) as Comprobante,
	FC.FactFec Emision,
	CASE WHEN FC.FactVto1 = '01/01/1753' THEN '01/01/2000' ELSE FC.FactVto1 END Vencimiento,
	/*
	RR.FactFecCnc Cancelacion,
	CASE WHEN RR.FactFecCnc <> '01/01/1753' THEN 'S' ELSE 'N' END Cancelado,
	CASE WHEN DATEDIFF(MONTH, FC.FactVto1, RR.FactFecCnc) > 0 THEN DATEDIFF(MONTH, FC.FactVto1, RR.FactFecCnc) ELSE 0 END DemoraPago,
	CASE WHEN DATEDIFF(DAY, FC.FactVto1, RR.FactFecCnc) <= 0 THEN '1. AL DIA'
		WHEN DATEDIFF(DAY, FC.FactVto1, RR.FactFecCnc) < 15 THEN '2. HASTA 15 DIAS'
		WHEN DATEDIFF(DAY, FC.FactVto1, RR.FactFecCnc) < 30 THEN '3. HASTA 30 DIAS'
		WHEN DATEDIFF(DAY, FC.FactVto1, RR.FactFecCnc) < 60 THEN '4. HASTA 60 DIAS'
		WHEN DATEDIFF(DAY, FC.FactVto1, RR.FactFecCnc) >= 60 THEN '5. MAS DE 60 DIAS'
	END AS Grupos,
	*/
	SUBSTRING(CONVERT(VARCHAR(10), FC.FactVto1, 103),4,2) AS MesVto,
	SUBSTRING(CONVERT(VARCHAR(10), FC.FactVto1, 103),7,4) AS AñoVto,
	CASE WHEN FC.FrmCod IN (1,3) THEN RC.ResuImp ELSE -RC.ResuImp END AS ImporteFactura,
	--CASE WHEN FC.FrmCod IN (1,3) THEN RR.FactImpCnc ELSE -RR.FactImpCnc END AS ImporteCancelado
	FS.Fac1Are Area,
	FS.Fac1Ctg Categoria,
	FS.Fac1EttCod ETTCod
FROM [UPCN_COM_PROD].dbo.FACTUC FC
	OUTER APPLY (SELECT TOP(1) * FROM [UPCN_COM_PROD].dbo.RESUMC RC WHERE FC.SucCod = RC.SucCod 
						AND FC.CliCod = RC.CliCod AND FC.SumNro = RC.SumNro 
						AND FC.FactFec = RC.ResuFec AND FC.FrmCod = RC.ResuTpo AND FC.FactLet = RC.ResuLet AND FC.FactPtoV = RC.ResuPtoV AND FC.FactNro = RC.ResuNro
	) RC
	OUTER APPLY (SELECT TOP(1) * FROM [UPCN_COM_PROD].dbo.FACTUS FS WHERE FC.SucCod = FS.SucCod AND FC.CliCod = FS.CliCod AND FC.SumNro = FS.SumNro AND
		FC.FrmCod = FS.FrmCod and FC.FactLet = FS.FactLet and FC.FactPtoV = FS.FactPtoV and FC.FactNro = FS.FactNro 
		ORDER BY FS.Fac1Srv
	) FS

/*
	OUTER APPLY (SELECT FactFecCnc, FactImpCnc FROM UPCN_COM_PROD.dbo.FactMR RR WHERE FC.SucCod = RR.SucCod 
						AND FC.CliCod = RR.CliCod AND FC.SumNro = RR.SumNro 
						AND FC.FactFec = RR.FactFec AND FC.FrmCod = RR.FrmCod AND FC.FactLet = RR.FactLet AND FC.FactPtoV = RR.FactPtoV AND FC.FactNro = RR.FactNro
				) RR		
				*/
WHERE FC.SucCod = 1 AND FC.FrmCod IN (1,3,50) AND YEAR(FC.FactFec) >= YEAR(GETDATE())-1 /*AND FC.CliCod <> 1100*/ AND FC.FactPtoV in (0,12,13,14) /*and FC.Factquin <> 9 and FC.FactAnu <> 1*/ 
	and FC.FactNro > 0
2024-09-27 13:04:24 - Vista exportada: dbo.ReporteFacturacion-bak
/****** Object:  View [dbo].[ReporteFacturacionDetallado]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON



/* drop view ReporteFacturacionDetallado*/
create view [dbo].[ReporteFacturacionDetallado] AS
SELECT Socio, Suministro, Comprobante, FechaEmision, FechaVencimiento, Servicio, Area, Categoria, Tarifa, Subtotal, Energetico,
	SUM(Importe) Importe, SUM(Saldo) Saldo
FROM
(
	SELECT 
		FC.CliCod Socio,
		FC.SumNro Suministro,
		CONCAT(FC.FrmCod, '-', FC.FactLet, '-', FC.FactPtoV, '-', FC.FactNro) Comprobante,
		FC.FactFec AS FechaEmision,		
		FC.FactVto1 AS FechaVencimiento,
		CASE WHEN FC.FactVto1 > GETDATE() THEN 'N' ELSE 'S' END Vencida,
		FS.Fac1Srv Servicio,
		FS.Fac1Are Area,
		FS.Fac1Ctg Categoria,
		FS.Fac1EttCod Tarifa,
		CASE WHEN FC.FrmCod = 50 THEN -FI.Fac2Imp1 ELSE FI.Fac2Imp1 END Importe,
		CASE WHEN FC.FrmCod = 50 THEN -FI.Fac2Sdo ELSE FI.Fac2Sdo END Saldo,
		CASE WHEN FI.CliCod = 1100 THEN 'Municipalidad' 
			WHEN FI.Fac2Cnp BETWEEN 0 and 38 AND FI.Fac2Itm NOT BETWEEN 2007 and 2010 THEN 'Energía'
			WHEN FI.Fac2Itm BETWEEN 2007 and 2010 THEN 'ICT'
			WHEN FI.Fac2Cnp in (200, 901) THEN 'Cuota Capital'
			WHEN FI.Fac2Cnp BETWEEN 700 and 750 THEN 'Impuestos'
			WHEN FI.Fac1Srv = 10 AND (FI.Fac2Cnp BETWEEN 100 and 110 OR FI.Fac2Cnp BETWEEN 346 AND 351 OR FI.Fac2Cnp BETWEEN 390 AND 602
				OR FI.Fac2Cnp = 960) THEN 'Servicios Sociales'
			WHEN FI.Fac1Srv = 5 AND (FI.Fac2Cnp BETWEEN 620 and 646 OR FI.Fac2Cnp BETWEEN 661 and 675) THEN 'Telecomunicaciones'
			WHEN FI.Fac2Itm = 8550 THEN 'Suscrip. Acciones'
			ELSE 'Otros' END Subtotal,
		CASE WHEN FC.FactEnerSN = 'N' THEN 'No energético' ELSE 'Energético' END AS Energetico
	FROM [UPCN_COM_PROD].dbo.FACTUC FC
		OUTER APPLY (SELECT TOP(1) * FROM [UPCN_COM_PROD].dbo.FACTUS FS WHERE FC.SucCod = FS.SucCod AND FC.CliCod = FS.CliCod AND FC.SumNro = FS.SumNro AND
			FC.FrmCod = FS.FrmCod and FC.FactLet = FS.FactLet and FC.FactPtoV = FS.FactPtoV and FC.FactNro = FS.FactNro 
			ORDER BY FS.Fac1Srv
		) FS
		JOIN [UPCN_COM_PROD].dbo.FACTUI FI ON (FC.SucCod = FI.SucCod and FC.CliCod = FI.CliCod and FC.SumNro = FI.SumNro and FC.FrmCod = FI.FrmCod 
			and FC.FactLet = FI.FactLet and FC.FactPtoV = FI.FactPtoV and FC.FactNro = FI.FactNro)

	WHERE FC.SucCod = 1 AND FC.FrmCod IN (1,3,50) AND YEAR(FC.FactFec) >= YEAR(GETDATE())-1 /*AND FC.CliCod <> 1100*/ AND FC.FactPtoV in (0,12,13,14)
		and FC.Factquin <> 9 /*and FC.FactAnu <> 1*/  -- ¿Qué pasa con las anuladas por NC? ¿No estoy incluyendo la NC sin incluir la original?
		and FC.FactNro > 0
) X
GROUP BY Socio, Suministro, Comprobante, FechaEmision, FechaVencimiento, Servicio, Area, Categoria, Tarifa, Subtotal, Energetico
2024-09-27 13:04:24 - Vista exportada: dbo.ReporteFacturacionDetallado
/****** Object:  View [dbo].[ReporteFacturacionResumido]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON








/* drop view ReporteFacturacionResumido */
CREATE VIEW [dbo].[ReporteFacturacionResumido] AS

SELECT MesEmision, AñoEmision, FechaEmision, MesVto, AñoVto, Area, Categoria, Tarifa,
	Subtotal, SUM(Importe) Importe, SUM(Saldo) Saldo
FROM
(
	SELECT MONTH(FC.FactFec) AS MesEmision,
		YEAR(FC.FactFec) AS AñoEmision,
		FC.FactFec AS FechaEmision,
		MONTH(FC.FactVto1) AS MesVto,
		YEAR(FC.FactVto1) AS AñoVto,
		FS.Fac1Srv Servicio,
		FS.Fac1Are Area,
		FS.Fac1Ctg Categoria,
		FS.Fac1EttCod Tarifa,	
		CASE WHEN FC.FrmCod = 50 THEN -FI.Fac2Imp1 ELSE FI.Fac2Imp1 END Importe,
		CASE WHEN FC.FrmCod = 50 THEN -FI.Fac2Sdo ELSE FI.Fac2Sdo END Saldo,
		CASE WHEN FI.CliCod = 1100 THEN 'Municipalidad' 
			WHEN FI.Fac2Cnp BETWEEN 0 and 38 AND FI.Fac2Itm NOT BETWEEN 2007 and 2010 THEN 'Energía'
			WHEN FI.Fac2Itm BETWEEN 2007 and 2010 THEN 'ICT'
			WHEN FI.Fac2Cnp in (200, 901) THEN 'Cuota Capital'
			WHEN FI.Fac2Cnp BETWEEN 700 and 750 THEN 'Impuestos'
			WHEN FI.Fac1Srv = 10 AND (FI.Fac2Cnp BETWEEN 100 and 110 OR FI.Fac2Cnp BETWEEN 346 AND 351 OR FI.Fac2Cnp BETWEEN 390 AND 602
				OR FI.Fac2Cnp = 960) THEN 'Servicios Sociales'
			WHEN FI.Fac1Srv = 5 AND (FI.Fac2Cnp BETWEEN 620 and 646 OR FI.Fac2Cnp BETWEEN 661 and 675) THEN 'Telecomunicaciones'
			WHEN FI.Fac2Itm = 8550 THEN 'Suscrip. Acciones'
			ELSE 'Otros' END Subtotal
	FROM [UPCN_COM_PROD].dbo.FACTUC FC
		OUTER APPLY (SELECT TOP(1) * FROM [UPCN_COM_PROD].dbo.FACTUS FS WHERE FC.SucCod = FS.SucCod AND FC.CliCod = FS.CliCod AND FC.SumNro = FS.SumNro AND
			FC.FrmCod = FS.FrmCod and FC.FactLet = FS.FactLet and FC.FactPtoV = FS.FactPtoV and FC.FactNro = FS.FactNro 
			ORDER BY FS.Fac1Srv
		) FS
		JOIN [UPCN_COM_PROD].dbo.FACTUI FI ON (FC.SucCod = FI.SucCod and FC.CliCod = FI.CliCod and FC.SumNro = FI.SumNro and FC.FrmCod = FI.FrmCod 
			and FC.FactLet = FI.FactLet and FC.FactPtoV = FI.FactPtoV and FC.FactNro = FI.FactNro)

	WHERE FC.SucCod = 1 AND FC.FrmCod IN (1,3,50) AND YEAR(FC.FactFec) >= YEAR(GETDATE())-1 /*AND FC.CliCod <> 1100*/ AND FC.FactPtoV in (0,12,13,14)
		and FC.Factquin <> 9 and FC.FactAnu <> 1  -- ¿Qué pasa con las anuladas por NC? ¿No estoy incluyendo la NC sin incluir la original?
		and FC.FactNro > 0
) X
GROUP BY Servicio, Area, Categoria, Tarifa,
	MesEmision, AñoEmision, FechaEmision, MesVto, AñoVto, Subtotal
	/*, RC.ResuImp*/
2024-09-27 13:04:24 - Vista exportada: dbo.ReporteFacturacionResumido
/****** Object:  View [dbo].[ReporteOrdenesDePago]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON

/* drop  view [dbo].[ReporteOrdenesDePago] */
Create view [dbo].[ReporteOrdenesDePago] as
SELECT OP2.OP2Fec Fecha, OP2.OP1Nro OrdenPago, Op2Prv CodProveedor, P.PrvNom Nombre, OP2Imp Importe
  FROM [UPCN_ERP_PROD].[dbo].[ORDPA2] OP2
	JOIN [UPCN_ERP_PROD].[dbo].[PROVE1] P ON (OP2.OP2Prv = P.PrvCod AND P.SucCod = 1)
  where YEAR(OP2Fec) >= YEAR(GETDATE())-1
2024-09-27 13:04:24 - Vista exportada: dbo.ReporteOrdenesDePago
/****** Object:  View [dbo].[ReportePrepago]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
/****** Script for SelectTopNRows command from SSMS  ******/

CREATE VIEW ReportePrepago AS
SELECT c.fecha_creacion "Fecha Compra", 
	co.nombre Vendedor, 
	c.importe Importe,
	c.kw Kwh
FROM [UPCN_SISTEMAS_PREPAGO].[dbo].[compra] c
	JOIN [UPCN_SISTEMAS_PREPAGO].dbo.jhi_user u on (c.vendedor_id = u.id)
    JOIN [UPCN_SISTEMAS_PREPAGO].dbo.comerciante co on (co.id = u.comerciante_id)
WHERE c.estado_pago = 'Generado'

  --where fecha_creacion between '01/01/2023' and '01/02/2023'
2024-09-27 13:04:24 - Vista exportada: dbo.ReportePrepago
/****** Object:  View [dbo].[ReporteSueldos]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON








/* drop view ReporteSueldos */
create view [dbo].[ReporteSueldos] as
select LiqAno Año, LiqMes Mes, CONCAT('01/', RIGHT('00' + CAST(LiqMes as VARCHAR(2)), 2), '/', LiqAno) Fecha, 
	LiqLeg Legajo, 
	E1.EmpNom Nombre,
	CONCAT(E2.CafCod, ' | ', FR.ObrDsc) AS Frente,
	TL.TpoLiqDsc 'Tipo Liquidacion',
	Liq1Cnc Concepto,
	CONCAT(RIGHT(CONCAT('0000', Liq1Cnc), 4), ' | ', C.ConDsc) 'Descripción Concepto',
	Liq1Cal Importe,
	CONCAT(Liq1TpoCo, ' | ',
		CASE WHEN Liq1TpoCo = 1 THEN 'Remunerativo' ELSE
		CASE WHEN Liq1TpoCo = 2 THEN 'No remunerativo' ELSE
		CASE WHEN Liq1TpoCo = 3 THEN 'Salario familiar' ELSE
		CASE WHEN Liq1TpoCo = 4 THEN 'Retenciones' ELSE
		CASE WHEN Liq1TpoCo = 5 THEN 'Deducciones vs.' ELSE
		CASE WHEN Liq1TpoCo = 6 THEN 'Aportes' ELSE
		CASE WHEN Liq1TpoCo = 7 THEN 'Provisión' ELSE ''
		END END END END END END END		
	) 'Tipo Concepto',
	LiqConTD 'Transitorio o definitivo',
	CASE WHEN (L1.Liq1TpoCo < 3 OR L1.Liq1TpoCo = 6) AND L1.LiqConTD = 'D' THEN Liq1Cal 
		ELSE 0 END ImporteParaBruto,
	CASE WHEN L1.Liq1TpoCo < 3 AND L1.LiqConTD = 'D' THEN Liq1Cal 
		WHEN (L1.Liq1TpoCo = 4 OR L1.Liq1TpoCo = 5) AND L1.LiqConTD = 'D' THEN -Liq1Cal 
		ELSE 0 END ImporteParaNeto,
	CASE WHEN L1.LiqConTD = 'D' THEN Liq1Cal ELSE 0 END ImporteSoloDefinitivos,
	CASE WHEN L1.Liq1Cnc BETWEEN 6807 AND 6997 THEN Liq1Cal ELSE 0 END TotalOrdenesPago,
	CASE WHEN L1.Liq1Cnc BETWEEN 3000 AND 3019 AND L1.LiqConTD = 'D' THEN 'BAE'
		WHEN L1.Liq1Cnc BETWEEN 6790 AND 6799 AND L1.LiqConTD = 'D' THEN 'Imp. Ganancias'
		WHEN (L1.Liq1Cnc = 3500 OR L1.Liq1Cnc = 3510) AND L1.LiqConTD = 'D' THEN 'SAC'
		WHEN L1.Liq1Cnc = 2084 AND L1.LiqConTD = 'D' THEN 'Plus Vacacional'
		WHEN L1.Liq1Cnc BETWEEN 2006 AND 2046 AND L1.LiqConTD = 'D' THEN 'Hs. Extras' /***** REVISAR *****/
		WHEN (L1.Liq1Cnc = 4450 OR L1.Liq1Cnc = 4460) AND L1.LiqConTD = 'D' THEN 'Art. 9'
		WHEN (L1.Liq1Cnc = 130 OR L1.Liq1Cnc = 135) AND L1.LiqConTD = 'D' THEN 'Jubilados Luz/Gas'
		WHEN (L1.Liq1TpoCo = 6) THEN 'Aportes'		
		ELSE 'General'
	END GrupoDeInteres,
	(SELECT ConCta FROM [UPCN_RRHH_PROD].dbo.CONCEPLEVEL1 C1 
		WHERE L1.LiqSuc = C1.SucCod and C1.ConCod = L1.Liq1Cnc and C1.ConCodDC = 'C'
			AND C1.ConVig = '01/01/1753' AND C1.ConSS = E2.CafCod) AS CuentaCredito,
	(SELECT ConCta FROM [UPCN_RRHH_PROD].dbo.CONCEPLEVEL1 C2
		WHERE L1.LiqSuc = C2.SucCod and C2.ConCod = L1.Liq1Cnc and C2.ConCodDC = 'D'
			AND C2.ConVig = '01/01/1753' AND C2.ConSS = E2.CafCod) AS CuentaDebito,
	FIJOS.EmpCVal1 'Cpto val.fijo 1',
	FIJOS.EmpCVal2 'Cpto val.fijo 2',
	E2.CenCod CodCentroCosto,
	CTO.CctDsc CentroCosto
from [UPCN_RRHH_PROD].dbo.LIQUID1 L1
	join [UPCN_RRHH_PROD].dbo.EMPLE1 E1 ON (L1.LiqSuc = E1.SucCod AND L1.LiqLeg = E1.EmpLeg)
	join [UPCN_RRHH_PROD].dbo.EMPLE2 E2 ON (L1.LiqSuc = E2.SucCod AND L1.LiqLeg = E2.EmpLeg AND E2.EmpVig = '01/01/1753')
	join [UPCN_RRHH_PROD].dbo.CONCE21 C ON (L1.LiqSuc = C.SucCod and L1.Liq1Cnc = C.ConCod and C.ConVig = '01/01/1753')
	left join [UPCN_RRHH_PROD].dbo.FRENTE FR ON (E2.CafCod = FR.ObrCod)
	join [UPCN_RRHH_PROD].dbo.TIPLIQ TL ON (L1.LiqTpoLiq = TL.TpoLiqCod)
	outer apply ( 
		/* 05/07/2024: Pedido por Johanna y Gaby al presentar Planilla22 v1. 
		Lo armo así para asegurarme de no duplicar filas.
		ESTO VA A HABER QUE REHACERLO EN UN REPORTE QUE ARRANQUE DEL LEGAJO ("INFORME DE PERSONAL"), 
		ACÁ SE PIERDEN FILAS DE CONCEPTOS QUE TIENEN VALORES FIJOS PERO NO FUERON LIQUIDADOS (O AUN NO).
		*/
		select top(1) FL1.EmpCVal1, FL1.EmpCVal2
		from [UPCN_RRHH_PROD].[dbo].[FIJOSLEVEL1] FL1
		where SucCod = 1 and EmpVig = '01/01/1753' and EmpCCodVig = '01/01/1753' and EmpCVig = '01/01/1753'
			and FL1.EmpLeg = L1.LiqLeg and FL1.EmpCCod = L1.Liq1Cnc
	) FIJOS
	left join [UPCN_ERP_PROD].[dbo].[CTOCTO] CTO ON (E2.CenCod = CTO.CctCod)
where L1.LiqSuc = 1 --and LiqLeg < 5000 
	--and L1.Liq1Cnc in (100, 3800, 6798, 8995)
	and LiqTpoLiq in ('0', '4', '7', 'I', 'J')
	--and L1.LiqConTD = 'D'
	--and LiqAno >= 2023 --and LiqMes in (3,4)
	and (LiqAno >= 2020 and LiqAno < 2100) --!

	-- TEST
	--and LiqAno = 2023 and LiqMes = 6 and LiqLeg = 270
2024-09-27 13:04:24 - Vista exportada: dbo.ReporteSueldos
/****** Object:  View [dbo].[TelecomunicacionesNAP]    Script Date: 27/09/2024 13:04:24 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
/* DROP VIEW TelecomunicacionesNAP */
CREATE VIEW 
	TelecomunicacionesNAP
AS
SELECT
    CO.CliCod Socio
    ,CO.SumNro Suministro
	,P.CliApe Nombre
	,CONCAT(TRIM(I.InmCllDsc), ' ', I.InmAlt) Domicilio
    , CASE WHEN TRIM(Sum2Port) = 'SI' OR Sum2Port = '' OR Sum2Port IS NULL THEN 'Sin datos' ELSE Sum2Port END NAP
	,CO.Sum2Sts
FROM [UPCN_COM_PROD].dbo.CONTRATO CO	
	JOIN [UPCN_COM_PROD].dbo.PERSONA P ON (CO.SucCod = P.SucCod AND CO.CliCod = P.CliCod)
	JOIN [UPCN_COM_PROD].dbo.CUENTA C ON (CO.SucCod = C.SucCod AND CO.CliCod = C.CliCod AND CO.SumNro = C.SumNro)
	JOIN [UPCN_COM_PROD].dbo.INMUEBLE I ON (C.InmCod = I.InmCod)
	OUTER APPLY (
		SELECT TOP(1) FC.FactNro 
		FROM [UPCN_COM_PROD].dbo.FACTUC FC 
		WHERE FC.SucCod = CO.SucCod AND FC.CliCod = CO.CliCod AND FC.SumNro = CO.SumNro 
			AND FC.FactFec > DATEADD(MONTH, -2, GETDATE())
	) F
WHERE CO.SucCod = 1 and CO.SrvCod = 5 and Sum2Sts < 4
	AND F.FactNro IS NOT NULL
2024-09-27 13:04:25 - Vista exportada: dbo.TelecomunicacionesNAP
2024-09-27 13:04:29 - NÃºmero de funciones encontradas: 0

2024-09-27 13:04:29 - Cambios preparados para Git.
[main 2e3386b] ActualizaciÃ³n de vistas y funciones - 2024-09-27 13:04:29
 14 files changed, 662 insertions(+), 44 deletions(-)
 create mode 100644 SQL_Exports/Vistas/dbo_ConsumosEnCero.sql
 create mode 100644 SQL_Exports/Vistas/dbo_Geo.sql
 create mode 100644 SQL_Exports/Vistas/dbo_ReporteCobranza.sql
 create mode 100644 SQL_Exports/Vistas/dbo_ReporteCuotaCapital.sql
 create mode 100644 SQL_Exports/Vistas/dbo_ReporteDeuda.sql
 create mode 100644 SQL_Exports/Vistas/dbo_ReporteFacturacion-bak.sql
 create mode 100644 SQL_Exports/Vistas/dbo_ReporteFacturacionDetallado.sql
 create mode 100644 SQL_Exports/Vistas/dbo_ReporteFacturacionResumido.sql
 create mode 100644 SQL_Exports/Vistas/dbo_ReporteOrdenesDePago.sql
 create mode 100644 SQL_Exports/Vistas/dbo_ReportePrepago.sql
 create mode 100644 SQL_Exports/Vistas/dbo_ReporteSueldos.sql
 create mode 100644 SQL_Exports/Vistas/dbo_TelecomunicacionesNAP.sql
2024-09-27 13:04:29 - Commit realizado con el mensaje: 'ActualizaciÃ³n de vistas y funciones - 2024-09-27 13:04:29'
Enumerating objects: 21, done.
Counting objects: 100% (21/21), done.
Delta compression using up to 28 threads
Compressing objects: 100% (17/17), done.
Writing objects: 100% (18/18), 20.54 KiB | 2.93 MiB/s, done.
Total 18 (delta 2), reused 0 (delta 0), pack-reused 0 (from 0)
remote: Resolving deltas: 100% (2/2), completed with 1 local object.
To https://github.com/UPCN-Nestor/reportes-sql.git
   3cf0596..2e3386b  main -> main
2024-09-27 13:04:31 - Cambios subidos al repositorio remoto.
2024-09-27 13:04:31 - Proceso de exportaciÃ³n y Git finalizado.
La transcripción se ha detenido. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
PS C:\Repos\reportes-sql> .\backup-scripts-vistas.ps1
La transcripción ha comenzado. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
2024-09-27 13:06:34 - Iniciando proceso de exportaciÃ³n...
2024-09-27 13:06:34 - Conectado al servidor SQL 192.168.0.230 y a la base de datos UPCN_REPORTES correctamente.
2024-09-27 13:06:35 - NÃºmero de vistas encontradas: 12
/****** Object:  View [dbo].[ConsumosEnCero]    Script Date: 27/09/2024 13:06:35 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
CREATE VIEW ConsumosEnCero AS
SELECT XX.*,
    C2.CnsKwAct UltLectura
FROM (SELECT Socio,
             Suministro,
             STRING_AGG(Medidor, ', ')                                                          Medidores,
             SUM(Consumo)                                                                       Consumo,
             CTA.SumNomPos                                                                      Nombre,
             CONCAT(TRIM(INM.InmCllDsc), ' ', INM.InmAlt , ' ', INM.InmPis, ' ', REPLACE(INM.InmDto, '"','')) Domicilio,
             MAX(FechaUltimaToma) FechaUltimaToma,
			 INM.InmLatitud Lat,
			 INM.InmLongitud Lon,
			 Area
      FROM (SELECT C.CliCod                             Socio,
                   C.SumNro                             Suministro,
                   CONCAT(CO.CnsTpoMdd, '-', CO.CnsMdd) Medidor,
                   SUM(CO.CnsKwCns)                     Consumo,
                   MAX(CnsFec)                          FechaUltimaToma,
				   C.Sum2Are Area				  
            FROM [UPCN_COM_PROD].dbo.CONSUM CO
                     JOIN [UPCN_COM_PROD].dbo.CONTRATO C
                          ON (CO.CnsSuc = C.SucCod AND CO.CliCod = C.CliCod AND CO.SumNro = C.SumNro AND
                              CO.CnsSrv = C.SrvCod)
            WHERE CO.CnsSuc = 1
              AND C.Sum2Sts IN (1, 2)
              AND C.CliCod <> 1100
              AND CO.CnsSrv = 1
              AND CO.CnsFec > '01/01/2024'
            GROUP BY C.CliCod, C.SumNro, CO.CnsTpoMdd, CO.CnsMdd, C.Sum2Are
            ) X
               JOIN [UPCN_COM_PROD].dbo.CUENTA CTA ON (X.Socio = CTA.CliCod AND X.Suministro = CTA.SumNro AND CTA.SucCod = 1)
               JOIN [UPCN_COM_PROD].dbo.INMUEBLE INM ON (CTA.SucCod = INM.SucCod AND CTA.InmCod = INM.InmCod)
      GROUP BY Socio, Suministro, CTA.SumNomPos, INM.InmCllDsc, INM.InmAlt, INM.InmPis, INM.InmDto, INM.InmLatitud, INM.InmLongitud, Area
      HAVING SUM(Consumo) < 20
    ) XX
    JOIN [UPCN_COM_PROD].dbo.CONSUM C2 ON (C2.CnsSuc = 1 AND C2.CnsSrv = 1 AND XX.Socio = C2.CliCod AND XX.Suministro = C2.SumNro AND XX.FechaUltimaToma = C2.CnsFec)
2024-09-27 13:06:35 - Vista exportada: dbo.ConsumosEnCero
/****** Object:  View [dbo].[Geo]    Script Date: 27/09/2024 13:06:35 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON



CREATE VIEW Geo AS
select c.CliCod Socio, c.SumNro Suministro, CONCAT(c.CliCod, '-', c.SumNro) "Soc-Sumi",
	i.InmLatitud Latitud, i.InmLongitud Longitud
from [UPCN_COM_PROD].dbo.[CUENTA] c
	join [UPCN_COM_PROD].dbo.[INMUEBLE] i
		on (c.SucCod = i.SucCod and c.InmCod = i.InmCod)
2024-09-27 13:06:35 - Vista exportada: dbo.Geo
/****** Object:  View [dbo].[ReporteCobranza]    Script Date: 27/09/2024 13:06:35 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON






/* COBRANZAS (Recaudacion Mensual) */

/* DROP VIEW ReporteCobranza */
CREATE VIEW [dbo].[ReporteCobranza] AS
SELECT CAST('01/' + RIGHT('00' + CAST(MONTH(P2.Pa1Fec) AS VARCHAR), 2) + '/' + CAST(YEAR(P2.Pa1Fec) AS VARCHAR) AS DATE) AS Periodo,
       CASE WHEN (P6.Pa6Ent = '9999') THEN 'cj. CHEQUE' 
		        WHEN (P6.Pa6Ent = 'EFEC') THEN 'cj. EFECTIVO' 
				WHEN (P6.Pa6Ent = '1036') THEN 'cj. DEBITO'
				WHEN (P6.Pa6Ent = '9001' OR P6.Pa6Ent = '9002' OR P6.Pa6Ent = '9852' OR P6.Pa6Ent = '9854') THEN 'z. TRANSFERENCIA'
				WHEN (P6.Pa6Ent = '9600' OR P6.Pa6Ent = '9650' OR P6.Pa6Ent = 'EPAN') THEN 'PREPAGO'
				WHEN (P6.Pa6Ent = '9750' OR P6.Pa6Ent = '9760' OR P6.Pa6Ent = '9761') THEN 'OFICINA VIRTUAL'
				WHEN (P6.Pa6Ent = '1040') THEN 'MUNICIPALIDAD'
				WHEN (P6.Pa6Ent = '9060') THEN 'COMPENSACIÓN'
				WHEN (P6.Pa6Ent = '9100') THEN 'PAGO FACIL'
				WHEN (P6.Pa6Ent = '9400') THEN 'RED LINK'
				WHEN (P6.Pa6Ent = '9300') THEN 'BAPRO'
				WHEN (P6.Pa6Ent = '9450') THEN 'BANELCO'
				WHEN (P6.Pa6Ent = '9200') THEN 'RIPSA'
				WHEN (P6.Pa6Ent = '9800') THEN 'COBROEXPRESS'
				WHEN (P6.Pa6Ent = '9900') THEN 'RAPIPAGO'
				WHEN (P6.Pa6Ent = '9001') THEN 'BCO. PCIA.'
				WHEN (P6.Pa6Ent = '9500') THEN 'BCO. MACRO'
				WHEN (P6.Pa6Ent = '9007') THEN 'BCO. RÍO'
				WHEN (P6.Pa6Ent = '9853') THEN 'BCO. RÍO TRANSF.'
				WHEN (P6.Pa6Ent = '9851') THEN 'BCO. PCIA. TRANSF.'
				WHEN (P6.Pa6Ent = '9700') THEN 'PRONTO PAGO'
				WHEN (P6.Pa6Ent = '9950') THEN 'COOP. CRÉDITO'
				WHEN (P6.Pa6Ent = '9000') THEN 'BCO. NACIÓN'
				ELSE 'OTROS'
		   END AS Ente,
		   CASE WHEN (P6.Pa6Ent = '9999') OR (P6.Pa6Ent = 'EFEC') OR (P6.Pa6Ent = '1036') THEN 'CAJAS'
				WHEN (P6.Pa6Ent = '9001' OR P6.Pa6Ent = '9002' OR P6.Pa6Ent = '9852' OR P6.Pa6Ent = '9854')  THEN 'z. TRANSFERENCIA'
				WHEN (P6.Pa6Ent = '9600' OR P6.Pa6Ent = '9650' OR P6.Pa6Ent = 'EPAN') THEN 'PREPAGO'
				WHEN (P6.Pa6Ent = '9750' OR P6.Pa6Ent = '9760' OR P6.Pa6Ent = '9761') THEN 'WEB'
				WHEN (P6.Pa6Ent = '1040') THEN 'MUNICIPALIDAD'
				WHEN (P6.Pa6Ent = '9060') THEN 'COMPENSACIÓN'
				WHEN (P6.Pa6Ent = '9400') OR (P6.Pa6Ent = '9450') THEN 'BANCA ELECTRÓNICA'
				WHEN (P6.Pa6Ent = '9300') OR (P6.Pa6Ent = '9200') OR (P6.Pa6Ent = '9800') OR (P6.Pa6Ent = '9900') OR (P6.Pa6Ent = '9100') OR (P6.Pa6Ent = '9001' OR P6.Pa6Ent = '9500' OR P6.Pa6Ent = '9007' OR P6.Pa6Ent = '9853' OR P6.Pa6Ent = '9851' 
						OR P6.Pa6Ent = '9700' OR P6.Pa6Ent = '9950' OR P6.Pa6Ent = '9000' 
				) THEN 'BANCO'
				ELSE 'OTROS' 
		   END AS Grupo,
		   P6.Pa6Ent AS "Código Ente",
		   P6.Pa6Imp AS Importe,
		   P2.Pa1Fec AS Fecha,
		   P2.Pa1Cjr AS Cajero,
		   P2.Pa2Rec AS Recibo,
		   P6.Pa6Cta AS Cuenta
FROM UPCN_COM_PROD.dbo.PAGAD2 P2 JOIN UPCN_COM_PROD.dbo.PAGAD6 P6 ON (P2.SucCod = P6.SucCod AND P2.Pa1Fec = P6.Pa1Fec AND P2.Pa1Cjr = P6.Pa1Cjr AND P2.Pa2Rec = P6.Pa2Rec)
WHERE P2.SucCod = 1 AND P2.Pa1Fec > '01/01/2019'
2024-09-27 13:06:35 - Vista exportada: dbo.ReporteCobranza
/****** Object:  View [dbo].[ReporteCuotaCapital]    Script Date: 27/09/2024 13:06:35 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON

/* drop VIEW ReporteCuotaCapital */
CREATE VIEW ReporteCuotaCapital AS
select YEAR(Fecha) Año, MONTH(Fecha) Mes, Caso,
	SUM(SaldoCC) SaldoCC, SUM(SaldoE) SaldoE,
	SUM(ImporteCC) ImporteCC, SUM(ImporteE) ImporteE,
	COUNT(*) Cantidad
from
(
	select FC.FactFec Fecha, CS.CompSdo SaldoCC, CS2.CompSdo SaldoE,
		CASE WHEN CS.CompSdo IS NULL and CS2.CompSdo IS NULL THEN 'Ambas Pagas'
			WHEN CS.CompSdo IS NOT NULL and CS2.CompSdo IS NULL THEN 'CC Impaga'
			WHEN CS.CompSdo IS NULL and CS2.CompSdo IS NOT NULL THEN 'Energía Impaga'
			WHEN CS.CompSdo IS NOT NULL and CS2.CompSdo IS NOT NULL THEN 'Ambas Impagas'
		END Caso,
		FE.Fac7NoEImp ImporteCC, FE.Fac7EneImp ImporteE
	from UPCN_COM_PROD.dbo.FACTUC FC
		join UPCN_COM_PROD.dbo.FACTUE FE ON (FC.SucCod = FE.SucCod and FC.CliCod = FE.CliCod and FC.SumNro = FE.SumNro 
			and FC.FrmCod = FE.FrmCod and FC.FactLet = FE.FactLet and FC.FactPtoV = FE.FactPtoV and FC.FactNro = FE.FactNro)
		left join UPCN_COM_PROD.dbo.COMSAL CS on (FC.SucCod = CS.SucCod and FC.CliCod = CS.CliCod and FC.SumNro = CS.SumNro
			and FC.FrmCod = CS.CompTpo and FC.FactLet = CS.CompLet and FC.FactPtoV = CS.CompPtoV and FC.FactNro = CS.CompNro)
		left join UPCN_COM_PROD.dbo.COMSAL CS2 ON (FE.SucCod = CS2.SucCod and FE.CliCod = CS2.CliCod and FE.SumNro = CS2.SumNro
			and FE.Fac7EneFrm = CS2.CompTpo and FE.Fac7EneLet = CS2.CompLet and FE.Fac7EnePto = CS2.CompPtoV and FE.Fac7EneNro = CS2.CompNro)		
	where FC.SucCod = 1 and FC.FactPtoV = 14
		and FC.FactFec > '01/01/2022'
		and FC.FactVto1 < GETDATE()
		and FC.FactFec IS NOT NULL
) x
group by YEAR(Fecha), MONTH(Fecha), Caso
2024-09-27 13:06:35 - Vista exportada: dbo.ReporteCuotaCapital
/****** Object:  View [dbo].[ReporteDeuda]    Script Date: 27/09/2024 13:06:35 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON




/* drop view [dbo].[ReporteDeuda] */
create view [dbo].[ReporteDeuda] as

SELECT CS.CliCod as Socio,
	CS.SumNro as Suministro,
	CONCAT(CS.CliCod, '-',CS.SumNro) as "Soc-Sumi",
	P.CliApe as Nombre,
	FS.Fac1EttCod as Tarifa,
	FS.Fac1Srv as ServicioPrincipal,
	FS.Fac1Are as Area,
	CompTpo as TipoComprobante,
	CONCAT(CompTpo, '-', CompLet, '-', CompPtoV, '-', CompNro) as Comprobante,
	CompFec as Emision,
	CompVto1 as Vencimiento,
	YEAR(CompVto1) AS VencimientoAño,
	CONCAT(YEAR(CompVto1), '-', MONTH(CompVto1)) AS VencimientoAñoMes,
	CASE WHEN CompVto1 > GETDATE() THEN 'N' ELSE 'S' END Vencida,
	CASE WHEN CompTpo IN (1,3) THEN CompImp WHEN CompTpo IN (50,60) THEN CompImp * -1 END AS Saldo,
	CO.Sum2Sts Estado,
	CASE WHEN CO.Sum2Sts = 4 THEN 'Desconectado' ELSE 'Conectado' END EstadoCD,
	Sum2FecSts FechaEstado,
	CASE WHEN CompEnerSN = 'N' THEN 'No energético' ELSE 'Energético' END Energetico
FROM [UPCN_COM_PROD].dbo.COMSAL CS
	OUTER APPLY (SELECT TOP(1) CliApe FROM [UPCN_COM_PROD].dbo.PERSONA P WHERE CS.SucCod = P.SucCod and CS.CliCod = P.CliCod) P
	OUTER APPLY (SELECT TOP(1) * FROM [UPCN_COM_PROD].dbo.CONTRATO CO WHERE CS.SucCod = CO.SucCod AND CS.CliCod = CO.CliCod AND CS.SumNro = CO.SumNro 
		ORDER BY CO.SrvCod) CO
	OUTER APPLY (SELECT TOP(1) FS.Fac1EttCod, FS.Fac1Srv, FS.Fac1Are 
		FROM [UPCN_COM_PROD].dbo.FACTUS FS 
		WHERE CS.SucCod = FS.SucCod  AND CS.CliCod = FS.CliCod AND CS.SumNro = FS.SumNro AND CS.CompFec = FS.FactFec AND CS.CompTpo = FS.FrmCod 
			AND CS.CompLet = FS.FactLet AND CS.CompPtoV = FS.FactPtoV AND CS.CompNro = FS.FactNro 
		ORDER BY FS.Fac1Srv
	) FS
WHERE CS.SucCod = 1 AND CS.CliCod <> 1100  
	AND CS.CompPtoV IN (0,12,13,14) -- Hay deuda rara en pto.vta. 8
	AND CS.CompVto1 > '01/01/2022'
2024-09-27 13:06:35 - Vista exportada: dbo.ReporteDeuda
/****** Object:  View [dbo].[ReporteFacturacion-bak]    Script Date: 27/09/2024 13:06:35 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON




/* drop view ReporteFacturacion */
CREATE VIEW [dbo].[ReporteFacturacion-bak] AS
SELECT 
	FC.CliCod as Socio,
	FC.SumNro as Suministro,
	FC.FrmCod as TipoComprobante,
	CONCAT(FC.FrmCod, '-', FC.FactLet, '-', FC.FactPtoV, '-', FC.FactNro) as Comprobante,
	FC.FactFec Emision,
	CASE WHEN FC.FactVto1 = '01/01/1753' THEN '01/01/2000' ELSE FC.FactVto1 END Vencimiento,
	/*
	RR.FactFecCnc Cancelacion,
	CASE WHEN RR.FactFecCnc <> '01/01/1753' THEN 'S' ELSE 'N' END Cancelado,
	CASE WHEN DATEDIFF(MONTH, FC.FactVto1, RR.FactFecCnc) > 0 THEN DATEDIFF(MONTH, FC.FactVto1, RR.FactFecCnc) ELSE 0 END DemoraPago,
	CASE WHEN DATEDIFF(DAY, FC.FactVto1, RR.FactFecCnc) <= 0 THEN '1. AL DIA'
		WHEN DATEDIFF(DAY, FC.FactVto1, RR.FactFecCnc) < 15 THEN '2. HASTA 15 DIAS'
		WHEN DATEDIFF(DAY, FC.FactVto1, RR.FactFecCnc) < 30 THEN '3. HASTA 30 DIAS'
		WHEN DATEDIFF(DAY, FC.FactVto1, RR.FactFecCnc) < 60 THEN '4. HASTA 60 DIAS'
		WHEN DATEDIFF(DAY, FC.FactVto1, RR.FactFecCnc) >= 60 THEN '5. MAS DE 60 DIAS'
	END AS Grupos,
	*/
	SUBSTRING(CONVERT(VARCHAR(10), FC.FactVto1, 103),4,2) AS MesVto,
	SUBSTRING(CONVERT(VARCHAR(10), FC.FactVto1, 103),7,4) AS AñoVto,
	CASE WHEN FC.FrmCod IN (1,3) THEN RC.ResuImp ELSE -RC.ResuImp END AS ImporteFactura,
	--CASE WHEN FC.FrmCod IN (1,3) THEN RR.FactImpCnc ELSE -RR.FactImpCnc END AS ImporteCancelado
	FS.Fac1Are Area,
	FS.Fac1Ctg Categoria,
	FS.Fac1EttCod ETTCod
FROM [UPCN_COM_PROD].dbo.FACTUC FC
	OUTER APPLY (SELECT TOP(1) * FROM [UPCN_COM_PROD].dbo.RESUMC RC WHERE FC.SucCod = RC.SucCod 
						AND FC.CliCod = RC.CliCod AND FC.SumNro = RC.SumNro 
						AND FC.FactFec = RC.ResuFec AND FC.FrmCod = RC.ResuTpo AND FC.FactLet = RC.ResuLet AND FC.FactPtoV = RC.ResuPtoV AND FC.FactNro = RC.ResuNro
	) RC
	OUTER APPLY (SELECT TOP(1) * FROM [UPCN_COM_PROD].dbo.FACTUS FS WHERE FC.SucCod = FS.SucCod AND FC.CliCod = FS.CliCod AND FC.SumNro = FS.SumNro AND
		FC.FrmCod = FS.FrmCod and FC.FactLet = FS.FactLet and FC.FactPtoV = FS.FactPtoV and FC.FactNro = FS.FactNro 
		ORDER BY FS.Fac1Srv
	) FS

/*
	OUTER APPLY (SELECT FactFecCnc, FactImpCnc FROM UPCN_COM_PROD.dbo.FactMR RR WHERE FC.SucCod = RR.SucCod 
						AND FC.CliCod = RR.CliCod AND FC.SumNro = RR.SumNro 
						AND FC.FactFec = RR.FactFec AND FC.FrmCod = RR.FrmCod AND FC.FactLet = RR.FactLet AND FC.FactPtoV = RR.FactPtoV AND FC.FactNro = RR.FactNro
				) RR		
				*/
WHERE FC.SucCod = 1 AND FC.FrmCod IN (1,3,50) AND YEAR(FC.FactFec) >= YEAR(GETDATE())-1 /*AND FC.CliCod <> 1100*/ AND FC.FactPtoV in (0,12,13,14) /*and FC.Factquin <> 9 and FC.FactAnu <> 1*/ 
	and FC.FactNro > 0
2024-09-27 13:06:35 - Vista exportada: dbo.ReporteFacturacion-bak
/****** Object:  View [dbo].[ReporteFacturacionDetallado]    Script Date: 27/09/2024 13:06:35 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON



/* drop view ReporteFacturacionDetallado*/
create view [dbo].[ReporteFacturacionDetallado] AS
SELECT Socio, Suministro, Comprobante, FechaEmision, FechaVencimiento, Servicio, Area, Categoria, Tarifa, Subtotal, Energetico,
	SUM(Importe) Importe, SUM(Saldo) Saldo
FROM
(
	SELECT 
		FC.CliCod Socio,
		FC.SumNro Suministro,
		CONCAT(FC.FrmCod, '-', FC.FactLet, '-', FC.FactPtoV, '-', FC.FactNro) Comprobante,
		FC.FactFec AS FechaEmision,		
		FC.FactVto1 AS FechaVencimiento,
		CASE WHEN FC.FactVto1 > GETDATE() THEN 'N' ELSE 'S' END Vencida,
		FS.Fac1Srv Servicio,
		FS.Fac1Are Area,
		FS.Fac1Ctg Categoria,
		FS.Fac1EttCod Tarifa,
		CASE WHEN FC.FrmCod = 50 THEN -FI.Fac2Imp1 ELSE FI.Fac2Imp1 END Importe,
		CASE WHEN FC.FrmCod = 50 THEN -FI.Fac2Sdo ELSE FI.Fac2Sdo END Saldo,
		CASE WHEN FI.CliCod = 1100 THEN 'Municipalidad' 
			WHEN FI.Fac2Cnp BETWEEN 0 and 38 AND FI.Fac2Itm NOT BETWEEN 2007 and 2010 THEN 'Energía'
			WHEN FI.Fac2Itm BETWEEN 2007 and 2010 THEN 'ICT'
			WHEN FI.Fac2Cnp in (200, 901) THEN 'Cuota Capital'
			WHEN FI.Fac2Cnp BETWEEN 700 and 750 THEN 'Impuestos'
			WHEN FI.Fac1Srv = 10 AND (FI.Fac2Cnp BETWEEN 100 and 110 OR FI.Fac2Cnp BETWEEN 346 AND 351 OR FI.Fac2Cnp BETWEEN 390 AND 602
				OR FI.Fac2Cnp = 960) THEN 'Servicios Sociales'
			WHEN FI.Fac1Srv = 5 AND (FI.Fac2Cnp BETWEEN 620 and 646 OR FI.Fac2Cnp BETWEEN 661 and 675) THEN 'Telecomunicaciones'
			WHEN FI.Fac2Itm = 8550 THEN 'Suscrip. Acciones'
			ELSE 'Otros' END Subtotal,
		CASE WHEN FC.FactEnerSN = 'N' THEN 'No energético' ELSE 'Energético' END AS Energetico
	FROM [UPCN_COM_PROD].dbo.FACTUC FC
		OUTER APPLY (SELECT TOP(1) * FROM [UPCN_COM_PROD].dbo.FACTUS FS WHERE FC.SucCod = FS.SucCod AND FC.CliCod = FS.CliCod AND FC.SumNro = FS.SumNro AND
			FC.FrmCod = FS.FrmCod and FC.FactLet = FS.FactLet and FC.FactPtoV = FS.FactPtoV and FC.FactNro = FS.FactNro 
			ORDER BY FS.Fac1Srv
		) FS
		JOIN [UPCN_COM_PROD].dbo.FACTUI FI ON (FC.SucCod = FI.SucCod and FC.CliCod = FI.CliCod and FC.SumNro = FI.SumNro and FC.FrmCod = FI.FrmCod 
			and FC.FactLet = FI.FactLet and FC.FactPtoV = FI.FactPtoV and FC.FactNro = FI.FactNro)

	WHERE FC.SucCod = 1 AND FC.FrmCod IN (1,3,50) AND YEAR(FC.FactFec) >= YEAR(GETDATE())-1 /*AND FC.CliCod <> 1100*/ AND FC.FactPtoV in (0,12,13,14)
		and FC.Factquin <> 9 /*and FC.FactAnu <> 1*/  -- ¿Qué pasa con las anuladas por NC? ¿No estoy incluyendo la NC sin incluir la original?
		and FC.FactNro > 0
) X
GROUP BY Socio, Suministro, Comprobante, FechaEmision, FechaVencimiento, Servicio, Area, Categoria, Tarifa, Subtotal, Energetico
2024-09-27 13:06:35 - Vista exportada: dbo.ReporteFacturacionDetallado
/****** Object:  View [dbo].[ReporteFacturacionResumido]    Script Date: 27/09/2024 13:06:35 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON








/* drop view ReporteFacturacionResumido */
CREATE VIEW [dbo].[ReporteFacturacionResumido] AS

SELECT MesEmision, AñoEmision, FechaEmision, MesVto, AñoVto, Area, Categoria, Tarifa,
	Subtotal, SUM(Importe) Importe, SUM(Saldo) Saldo
FROM
(
	SELECT MONTH(FC.FactFec) AS MesEmision,
		YEAR(FC.FactFec) AS AñoEmision,
		FC.FactFec AS FechaEmision,
		MONTH(FC.FactVto1) AS MesVto,
		YEAR(FC.FactVto1) AS AñoVto,
		FS.Fac1Srv Servicio,
		FS.Fac1Are Area,
		FS.Fac1Ctg Categoria,
		FS.Fac1EttCod Tarifa,	
		CASE WHEN FC.FrmCod = 50 THEN -FI.Fac2Imp1 ELSE FI.Fac2Imp1 END Importe,
		CASE WHEN FC.FrmCod = 50 THEN -FI.Fac2Sdo ELSE FI.Fac2Sdo END Saldo,
		CASE WHEN FI.CliCod = 1100 THEN 'Municipalidad' 
			WHEN FI.Fac2Cnp BETWEEN 0 and 38 AND FI.Fac2Itm NOT BETWEEN 2007 and 2010 THEN 'Energía'
			WHEN FI.Fac2Itm BETWEEN 2007 and 2010 THEN 'ICT'
			WHEN FI.Fac2Cnp in (200, 901) THEN 'Cuota Capital'
			WHEN FI.Fac2Cnp BETWEEN 700 and 750 THEN 'Impuestos'
			WHEN FI.Fac1Srv = 10 AND (FI.Fac2Cnp BETWEEN 100 and 110 OR FI.Fac2Cnp BETWEEN 346 AND 351 OR FI.Fac2Cnp BETWEEN 390 AND 602
				OR FI.Fac2Cnp = 960) THEN 'Servicios Sociales'
			WHEN FI.Fac1Srv = 5 AND (FI.Fac2Cnp BETWEEN 620 and 646 OR FI.Fac2Cnp BETWEEN 661 and 675) THEN 'Telecomunicaciones'
			WHEN FI.Fac2Itm = 8550 THEN 'Suscrip. Acciones'
			ELSE 'Otros' END Subtotal
	FROM [UPCN_COM_PROD].dbo.FACTUC FC
		OUTER APPLY (SELECT TOP(1) * FROM [UPCN_COM_PROD].dbo.FACTUS FS WHERE FC.SucCod = FS.SucCod AND FC.CliCod = FS.CliCod AND FC.SumNro = FS.SumNro AND
			FC.FrmCod = FS.FrmCod and FC.FactLet = FS.FactLet and FC.FactPtoV = FS.FactPtoV and FC.FactNro = FS.FactNro 
			ORDER BY FS.Fac1Srv
		) FS
		JOIN [UPCN_COM_PROD].dbo.FACTUI FI ON (FC.SucCod = FI.SucCod and FC.CliCod = FI.CliCod and FC.SumNro = FI.SumNro and FC.FrmCod = FI.FrmCod 
			and FC.FactLet = FI.FactLet and FC.FactPtoV = FI.FactPtoV and FC.FactNro = FI.FactNro)

	WHERE FC.SucCod = 1 AND FC.FrmCod IN (1,3,50) AND YEAR(FC.FactFec) >= YEAR(GETDATE())-1 /*AND FC.CliCod <> 1100*/ AND FC.FactPtoV in (0,12,13,14)
		and FC.Factquin <> 9 and FC.FactAnu <> 1  -- ¿Qué pasa con las anuladas por NC? ¿No estoy incluyendo la NC sin incluir la original?
		and FC.FactNro > 0
) X
GROUP BY Servicio, Area, Categoria, Tarifa,
	MesEmision, AñoEmision, FechaEmision, MesVto, AñoVto, Subtotal
	/*, RC.ResuImp*/
2024-09-27 13:06:35 - Vista exportada: dbo.ReporteFacturacionResumido
/****** Object:  View [dbo].[ReporteOrdenesDePago]    Script Date: 27/09/2024 13:06:35 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON

/* drop  view [dbo].[ReporteOrdenesDePago] */
Create view [dbo].[ReporteOrdenesDePago] as
SELECT OP2.OP2Fec Fecha, OP2.OP1Nro OrdenPago, Op2Prv CodProveedor, P.PrvNom Nombre, OP2Imp Importe
  FROM [UPCN_ERP_PROD].[dbo].[ORDPA2] OP2
	JOIN [UPCN_ERP_PROD].[dbo].[PROVE1] P ON (OP2.OP2Prv = P.PrvCod AND P.SucCod = 1)
  where YEAR(OP2Fec) >= YEAR(GETDATE())-1
2024-09-27 13:06:35 - Vista exportada: dbo.ReporteOrdenesDePago
/****** Object:  View [dbo].[ReportePrepago]    Script Date: 27/09/2024 13:06:35 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
/****** Script for SelectTopNRows command from SSMS  ******/

CREATE VIEW ReportePrepago AS
SELECT c.fecha_creacion "Fecha Compra", 
	co.nombre Vendedor, 
	c.importe Importe,
	c.kw Kwh
FROM [UPCN_SISTEMAS_PREPAGO].[dbo].[compra] c
	JOIN [UPCN_SISTEMAS_PREPAGO].dbo.jhi_user u on (c.vendedor_id = u.id)
    JOIN [UPCN_SISTEMAS_PREPAGO].dbo.comerciante co on (co.id = u.comerciante_id)
WHERE c.estado_pago = 'Generado'

  --where fecha_creacion between '01/01/2023' and '01/02/2023'
2024-09-27 13:06:35 - Vista exportada: dbo.ReportePrepago
/****** Object:  View [dbo].[ReporteSueldos]    Script Date: 27/09/2024 13:06:36 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON








/* drop view ReporteSueldos */
create view [dbo].[ReporteSueldos] as
select LiqAno Año, LiqMes Mes, CONCAT('01/', RIGHT('00' + CAST(LiqMes as VARCHAR(2)), 2), '/', LiqAno) Fecha, 
	LiqLeg Legajo, 
	E1.EmpNom Nombre,
	CONCAT(E2.CafCod, ' | ', FR.ObrDsc) AS Frente,
	TL.TpoLiqDsc 'Tipo Liquidacion',
	Liq1Cnc Concepto,
	CONCAT(RIGHT(CONCAT('0000', Liq1Cnc), 4), ' | ', C.ConDsc) 'Descripción Concepto',
	Liq1Cal Importe,
	CONCAT(Liq1TpoCo, ' | ',
		CASE WHEN Liq1TpoCo = 1 THEN 'Remunerativo' ELSE
		CASE WHEN Liq1TpoCo = 2 THEN 'No remunerativo' ELSE
		CASE WHEN Liq1TpoCo = 3 THEN 'Salario familiar' ELSE
		CASE WHEN Liq1TpoCo = 4 THEN 'Retenciones' ELSE
		CASE WHEN Liq1TpoCo = 5 THEN 'Deducciones vs.' ELSE
		CASE WHEN Liq1TpoCo = 6 THEN 'Aportes' ELSE
		CASE WHEN Liq1TpoCo = 7 THEN 'Provisión' ELSE ''
		END END END END END END END		
	) 'Tipo Concepto',
	LiqConTD 'Transitorio o definitivo',
	CASE WHEN (L1.Liq1TpoCo < 3 OR L1.Liq1TpoCo = 6) AND L1.LiqConTD = 'D' THEN Liq1Cal 
		ELSE 0 END ImporteParaBruto,
	CASE WHEN L1.Liq1TpoCo < 3 AND L1.LiqConTD = 'D' THEN Liq1Cal 
		WHEN (L1.Liq1TpoCo = 4 OR L1.Liq1TpoCo = 5) AND L1.LiqConTD = 'D' THEN -Liq1Cal 
		ELSE 0 END ImporteParaNeto,
	CASE WHEN L1.LiqConTD = 'D' THEN Liq1Cal ELSE 0 END ImporteSoloDefinitivos,
	CASE WHEN L1.Liq1Cnc BETWEEN 6807 AND 6997 THEN Liq1Cal ELSE 0 END TotalOrdenesPago,
	CASE WHEN L1.Liq1Cnc BETWEEN 3000 AND 3019 AND L1.LiqConTD = 'D' THEN 'BAE'
		WHEN L1.Liq1Cnc BETWEEN 6790 AND 6799 AND L1.LiqConTD = 'D' THEN 'Imp. Ganancias'
		WHEN (L1.Liq1Cnc = 3500 OR L1.Liq1Cnc = 3510) AND L1.LiqConTD = 'D' THEN 'SAC'
		WHEN L1.Liq1Cnc = 2084 AND L1.LiqConTD = 'D' THEN 'Plus Vacacional'
		WHEN L1.Liq1Cnc BETWEEN 2006 AND 2046 AND L1.LiqConTD = 'D' THEN 'Hs. Extras' /***** REVISAR *****/
		WHEN (L1.Liq1Cnc = 4450 OR L1.Liq1Cnc = 4460) AND L1.LiqConTD = 'D' THEN 'Art. 9'
		WHEN (L1.Liq1Cnc = 130 OR L1.Liq1Cnc = 135) AND L1.LiqConTD = 'D' THEN 'Jubilados Luz/Gas'
		WHEN (L1.Liq1TpoCo = 6) THEN 'Aportes'		
		ELSE 'General'
	END GrupoDeInteres,
	(SELECT ConCta FROM [UPCN_RRHH_PROD].dbo.CONCEPLEVEL1 C1 
		WHERE L1.LiqSuc = C1.SucCod and C1.ConCod = L1.Liq1Cnc and C1.ConCodDC = 'C'
			AND C1.ConVig = '01/01/1753' AND C1.ConSS = E2.CafCod) AS CuentaCredito,
	(SELECT ConCta FROM [UPCN_RRHH_PROD].dbo.CONCEPLEVEL1 C2
		WHERE L1.LiqSuc = C2.SucCod and C2.ConCod = L1.Liq1Cnc and C2.ConCodDC = 'D'
			AND C2.ConVig = '01/01/1753' AND C2.ConSS = E2.CafCod) AS CuentaDebito,
	FIJOS.EmpCVal1 'Cpto val.fijo 1',
	FIJOS.EmpCVal2 'Cpto val.fijo 2',
	E2.CenCod CodCentroCosto,
	CTO.CctDsc CentroCosto
from [UPCN_RRHH_PROD].dbo.LIQUID1 L1
	join [UPCN_RRHH_PROD].dbo.EMPLE1 E1 ON (L1.LiqSuc = E1.SucCod AND L1.LiqLeg = E1.EmpLeg)
	join [UPCN_RRHH_PROD].dbo.EMPLE2 E2 ON (L1.LiqSuc = E2.SucCod AND L1.LiqLeg = E2.EmpLeg AND E2.EmpVig = '01/01/1753')
	join [UPCN_RRHH_PROD].dbo.CONCE21 C ON (L1.LiqSuc = C.SucCod and L1.Liq1Cnc = C.ConCod and C.ConVig = '01/01/1753')
	left join [UPCN_RRHH_PROD].dbo.FRENTE FR ON (E2.CafCod = FR.ObrCod)
	join [UPCN_RRHH_PROD].dbo.TIPLIQ TL ON (L1.LiqTpoLiq = TL.TpoLiqCod)
	outer apply ( 
		/* 05/07/2024: Pedido por Johanna y Gaby al presentar Planilla22 v1. 
		Lo armo así para asegurarme de no duplicar filas.
		ESTO VA A HABER QUE REHACERLO EN UN REPORTE QUE ARRANQUE DEL LEGAJO ("INFORME DE PERSONAL"), 
		ACÁ SE PIERDEN FILAS DE CONCEPTOS QUE TIENEN VALORES FIJOS PERO NO FUERON LIQUIDADOS (O AUN NO).
		*/
		select top(1) FL1.EmpCVal1, FL1.EmpCVal2
		from [UPCN_RRHH_PROD].[dbo].[FIJOSLEVEL1] FL1
		where SucCod = 1 and EmpVig = '01/01/1753' and EmpCCodVig = '01/01/1753' and EmpCVig = '01/01/1753'
			and FL1.EmpLeg = L1.LiqLeg and FL1.EmpCCod = L1.Liq1Cnc
	) FIJOS
	left join [UPCN_ERP_PROD].[dbo].[CTOCTO] CTO ON (E2.CenCod = CTO.CctCod)
where L1.LiqSuc = 1 --and LiqLeg < 5000 
	--and L1.Liq1Cnc in (100, 3800, 6798, 8995)
	and LiqTpoLiq in ('0', '4', '7', 'I', 'J')
	--and L1.LiqConTD = 'D'
	--and LiqAno >= 2023 --and LiqMes in (3,4)
	and (LiqAno >= 2020 and LiqAno < 2100) --!

	-- TEST
	--and LiqAno = 2023 and LiqMes = 6 and LiqLeg = 270
2024-09-27 13:06:36 - Vista exportada: dbo.ReporteSueldos
/****** Object:  View [dbo].[TelecomunicacionesNAP]    Script Date: 27/09/2024 13:06:36 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
/* DROP VIEW TelecomunicacionesNAP */
CREATE VIEW 
	TelecomunicacionesNAP
AS
SELECT
    CO.CliCod Socio
    ,CO.SumNro Suministro
	,P.CliApe Nombre
	,CONCAT(TRIM(I.InmCllDsc), ' ', I.InmAlt) Domicilio
    , CASE WHEN TRIM(Sum2Port) = 'SI' OR Sum2Port = '' OR Sum2Port IS NULL THEN 'Sin datos' ELSE Sum2Port END NAP
	,CO.Sum2Sts
FROM [UPCN_COM_PROD].dbo.CONTRATO CO	
	JOIN [UPCN_COM_PROD].dbo.PERSONA P ON (CO.SucCod = P.SucCod AND CO.CliCod = P.CliCod)
	JOIN [UPCN_COM_PROD].dbo.CUENTA C ON (CO.SucCod = C.SucCod AND CO.CliCod = C.CliCod AND CO.SumNro = C.SumNro)
	JOIN [UPCN_COM_PROD].dbo.INMUEBLE I ON (C.InmCod = I.InmCod)
	OUTER APPLY (
		SELECT TOP(1) FC.FactNro 
		FROM [UPCN_COM_PROD].dbo.FACTUC FC 
		WHERE FC.SucCod = CO.SucCod AND FC.CliCod = CO.CliCod AND FC.SumNro = CO.SumNro 
			AND FC.FactFec > DATEADD(MONTH, -2, GETDATE())
	) F
WHERE CO.SucCod = 1 and CO.SrvCod = 5 and Sum2Sts < 4
	AND F.FactNro IS NOT NULL
2024-09-27 13:06:36 - Vista exportada: dbo.TelecomunicacionesNAP
2024-09-27 13:06:40 - NÃºmero de funciones encontradas: 2
/****** Object:  UserDefinedFunction [dbo].[ReporteAnalisisDeuda]    Script Date: 27/09/2024 13:08:14 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
/* drop function ReporteAnalisisDeuda */

CREATE function [dbo].[ReporteAnalisisDeuda](
	@año_desde int,
	@año_hasta int,
	@con_municipalidad int
)
RETURNS TABLE AS
RETURN

SELECT RESU.*, FS.*,
	CASE WHEN Grupos = '6. IMPAGO O SIN CONCILIAR' THEN 
		ImporteComprobante - COALESCE(SUM(ImporteCancelado) OVER (PARTITION BY CpteTipo, CpteLetra, CptePtoVta, CpteNumero), 0)
	ELSE
		ImporteCancelado
	END ImporteParaAgrupar
FROM
(
	SELECT YEAR(B.ResuVto1) * 100 +  MONTH(B.ResuVto1) AS Periodo,  
		CASE WHEN Marca='P' THEN 0 ELSE
			CASE WHEN B.ResuTpo IN (1,3) THEN B.ResuImp ELSE B.ResuImp * -1 END  
		END AS ImporteComprobante,
		CASE WHEN B.ResuTpo IN (1,3) THEN COALESCE(B.ResuImpCnc,0) ELSE COALESCE(B.ResuImpCnc,0) * -1 END AS ImporteCancelado,
		CASE 
--			WHEN B.Marca = 'I' AND B.ResuFecCnc IS NULL AND B.ResuImpCnc = 0 THEN '6. IMPAGO O SIN CONCILIAR'
			WHEN B.Marca = 'I' AND B.Pa3FecInt IS NULL AND B.ResuImpCnc = 0 THEN '6. IMPAGO O SIN CONCILIAR'
			WHEN DATEDIFF(DAY, B.ResuVto1, B.Pa3FecInt) <= 0 THEN '1. AL DIA'
			WHEN DATEDIFF(DAY, B.ResuVto1, B.Pa3FecInt) < 15 THEN '2. HASTA 15 DIAS'
			WHEN DATEDIFF(DAY, B.ResuVto1, B.Pa3FecInt) < 30 THEN '3. HASTA 30 DIAS'
			WHEN DATEDIFF(DAY, B.ResuVto1, B.Pa3FecInt) < 60 THEN '4. HASTA 60 DIAS'
			WHEN DATEDIFF(DAY, B.ResuVto1, B.Pa3FecInt) >= 60 THEN '5. MAS DE 60 DIAS'
		END AS Grupos,
		DATEDIFF(DAY, B.ResuVto1, B.Pa3FecInt) DiasVencido,
		B.CliCod Socio, B.SumNro Suministro, B.ResuFec Emision, B.ResuVto1 Vencimiento, B.Pa3FecInt Cancelacion,
		ResuTpo CpteTipo, ResuLet CpteLetra, ResuPtoV CptePtoVta, ResuNro CpteNumero, B.ResuEnerSN
	FROM (
		SELECT RC.ResuVto1, RC.SucCod, RC.CliCod, RC.SumNro, RC.ResuFec, RC.ResuTpo, RC.ResuLet, RC.ResuPtoV, RC.ResuNro,
			RC.ResuImp, RR.ResuImpCnc, RR.ResuFecCnc, RR.ResuTpoCnc, 'P' Marca, RR.Pa3FecInt, RC.ResuEnerSN
		FROM UPCN_COM_PROD.dbo.RESUMC RC WITH(NOLOCK) 
			JOIN (SELECT RR.SucCod, CliCod, SumNro, ResuFec, ResuTpo, ResuLet, ResuPtoV, ResuNro, ResuImpCnc, ResuFecCnc, ResuTpoCnc, COALESCE(Pa3FecInt, ResuFecCnc) Pa3FecInt
					FROM UPCN_COM_PROD.dbo.RESUMR RR WITH(NOLOCK)		
						LEFT JOIN UPCN_COM_PROD.dbo.PAGAD3 P3 WITH(NOLOCK) ON (RR.SucCod=P3.SucCod AND RR.CliCod=P3.Pa3Cli AND RR.SumNro=P3.Pa3Sum AND P3.Pa3Fec = RR.ResuFec AND P3.Pa3Tpo = RR.ResuTpo AND P3.Pa3Let = RR.ResuLet AND P3.Pa3PtoV = RR.ResuPtoV AND P3.Pa3Nro = RR.ResuNro AND P3.Pa2Rec=RR.ResuCptCnc )	
			   		) RR ON (RC.SucCod = RR.SucCod AND RC.CliCod = RR.CliCod AND RC.SumNro = RR.SumNro AND RC.ResuFec = RR.ResuFec AND
					RC.ResuTpo = RR.ResuTpo AND RC.ResuLet = RR.ResuLet AND RC.ResuPtoV = RR.ResuPtoV AND RC.ResuNro = RR.ResuNro)
	
		WHERE RC.SucCod = 1 AND RC.ResuTpo IN (1,3/*,50*/) -- Se excluyen NCs porque provocan valores mensuales de cobranza negativos.
			AND (RR.ResuTpoCnc = 60 OR RR.ResuTpoCnc = 70) AND RC.ResuVto1 BETWEEN '01/01/' + CAST(@año_desde as varchar) AND '31/12/' + CAST(@año_hasta as varchar) AND RC.CliCod <> 1100	
--AND RC.CliCod = 5082 AND RC.SumNro = 8
		   
		UNION
		SELECT RC.ResuVto1, RC.SucCod, RC.CliCod, RC.SumNro, RC.ResuFec, RC.ResuTpo, RC.ResuLet, RC.ResuPtoV, RC.ResuNro,
			RC.ResuImp/* - RC.ResuImp2 AS ResuImp*/, 0, null, null, 'I' Marca, null, null
		FROM UPCN_COM_PROD.dbo.RESUMC RC
			JOIN UPCN_COM_PROD.dbo.FACTUC FC ON (FC.SucCod = RC.SucCod AND FC.CliCod = RC.CliCod AND FC.SumNro = RC.SumNro 
					AND FC.FactFec = RC.ResuFec AND FC.FrmCod = RC.ResuTpo AND FC.FactLet = RC.ResuLet AND FC.FactPtoV = RC.ResuPtoV AND FC.FactNro = RC.ResuNro)
		WHERE RC.SucCod = 1 AND RC.ResuTpo IN (1,3/*,50*/) AND RC.ResuVto1 BETWEEN '01/01/' + CAST(@año_desde as varchar) AND '31/12/' + CAST(@año_hasta as varchar) 
			AND (RC.CliCod <> 1100 OR @con_municipalidad = 1) 
			AND FC.FactAnu <> 1
--AND RC.CliCod = 5082 AND RC.SumNro = 8
		) AS B
) RESU
OUTER APPLY (
	SELECT TOP(1) FS.Fac1Srv ServicioPrincipal, FS.Fac1Ctg Categoria, FS.Fac1EttCod Tarifa, FS.Fac1EttImpDec TarifaConEscalon, FS.Fac1Are Area
	FROM UPCN_COM_PROD.dbo.FACTUS FS
	WHERE FS.SucCod = 1 AND FS.CliCod = RESU.Socio AND FS.SumNro = RESU.Suministro AND FS.FrmCod = RESU.CpteTipo AND FS.FactLet = RESU.CpteLetra AND FS.FactPtoV = RESU.CptePtoVta AND FS.FactNro = RESU.CpteNumero
	ORDER BY FS.Fac1Srv
) FS


--select * from ReporteAnalisisDeuda(2023,2023,0) where Grupos like '6%' order by ImporteParaAgrupar desc
2024-09-27 13:08:14 - FunciÃ³n exportada: dbo.ReporteAnalisisDeuda
/****** Object:  UserDefinedFunction [dbo].[ReporteFacturacion]    Script Date: 27/09/2024 13:08:14 ******/
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON

/* drop function ReporteFacturacion */
create function [dbo].[ReporteFacturacion]()
RETURNS table
AS

/*****************************************************************************************************************************/
-- CONSULTA PARA ESTADISTICAS DE FACTURACION - IMPORTES 
/*****************************************************************************************************************************/
-- RESUMEN por comprobante, con peridos de emsision, vto, importe, remesa y servicio principal
--		SE ANEXA analisis de EE: periodo de consumo, tarifas, Consumos, Base Eneregia, Fact.No EE asociada
--			AGRUPA LOS IMPORTES por: CF, Base EE, ICT
-- Ultima modificacion 25-04-2024
/*****************************************************************************************************************************/
RETURN
SELECT c.CliCod AS Socio, c.SumNro AS Sumini, p.CliApe AS Nombre
		, YEAR(c.FactFec) AS AnoEmi, MONTH(c.FactFec) AS MesEmi
		, YEAR(c.FactVto1) AS AnoVto, MONTH(c.FactVto1) AS MesVto
		, CAST(CONVERT(VARCHAR(11), c.FactFec, 113) AS date) AS Emision
		, c.FactRgAfip AS FcAfip, c.FactEnerSN AS FcEE
		, c.FactCls AS FcCls, c.FrmCod AS FcTpo, c.FactLet AS FcLet, c.FactPtoV AS FcPtoV, c.FactNro AS FcNro, c.Factquin AS FcOrd
		, CAST(CONVERT(VARCHAR(11), c.FactVto1, 113) AS date) AS FecVto
		, CASE WHEN rc.ResuTpo=50 THEN (-rc.ResuImp) ELSE rc.ResuImp END AS ImpFactura
		, c.FactRem AS Remesa
		, CASE WHEN c.FactRem BETWEEN 21 AND 999 THEN 'EE'
			WHEN c.FactRem BETWEEN 5000 AND 5999  THEN 'SS'
			WHEN c.FactRem = 6101  THEN 'TEL'
			WHEN c.FactRem = 99999 THEN 'INT'
			ELSE 'OTRO' END AS SerPrin
		, c.FactLot AS LoteNro, s2.Fac1Are AS Area, s2.Fac1Rut AS Ruta
-- Fin datos del comprobante sin apertura por servicios-items .
		, s2.AnoCns, s2.MesCns
		, s2.Fac1CtgCon AS CatUPC
		, s2.Fac1EttCod AS TarOceba
		, s2.Fac1EttImp AS TarRango
		, s2.Fac1Ctg AS CatUPCSeg
		, s2.SEGMENTO AS Segmento
-- datos de la factura EE 
		, s2.UltLista -- lista utilizada, la ultima si  hay mas de una
		, s2.ImS1Cod AS FCSubTotCod, s2.ImS1Dsc AS FCSubTotDesc  -- subtotales en la impresion de la factura
		, s2.Consumo
		, CFSubtot AS ImpCF  -- Cargo Fijo
		, s2.ICT
		, s2.BaseEE AS ImpBaseEE  -- Importe del subtotal EE que es la base para los impuestos
-- datos de la factura No EE asociada a la EE 
		, s2.FactEneElec AS ImpTotFc-- Total Fact EE
		, s2.FactNoElec  AS ImpCCap-- Total Fact No Electrica
		, s2.Tot2Fact    AS ImpTotEEyCCap -- Total ambas facturas

-- Datos extras de la factura para control interno
		, s2.FrmNE AS FcCCtipo, s2.LetNE AS FcCClet, s2.PtoVNE AS FcCCptoV, s2.FactNroNE AS FcCCnro
		, CFCant AS CantItemCF
		, s2.Cantitems AS CantItemBaseEE
		, c.FactAnu -- Campos de anulacion de FC Factquin=9 win y FacAnu=1 Web
		, c.FactObs -- Campo en NC que anula Fact indica la factura de referencia
		, s2.Fac1MarEs, s2.Fac1MarLis

FROM 
	[UPCN_COM_PROD].dbo.FACTUC c WITH(NOLOCK) 
	JOIN [UPCN_COM_PROD].dbo.RESUMC rc WITH(NOLOCK) ON (c.SucCod=rc.SucCod AND c.CliCod=rc.CliCod AND c.SumNro=rc.SumNro AND c.FactFec=rc.ResuFec AND c.FrmCod=rc.ResuTpo AND c.FactLet=rc.ResuLet AND c.FactPtoV=rc.ResuPtoV AND c.FactNro=rc.ResuNro) 
	JOIN [UPCN_COM_PROD].dbo.PERSONA p WITH(NOLOCK) ON (c.SucCod=p.SucCod AND c.CliCod=p.CliCod) 

	LEFT JOIN ( -- DATOS-EE, tarifa, consumos, importes
-- SUBCONSULTA DE ANALISIS DE EE
		SELECT s.SucCod, s.Fac1Srv, s.CliCod, s.SumNro, s.FactFec, s.FrmCod, s.FactLet, s.FactPtoV, s.FactNro
			, s.Fac1AnoCns AS AnoCns, s.Fac1MesCns AS MesCns
			, s.Fac1Are, s.Fac1Rut, s.Fac1EttImp --, s.Fac1EttImpDec
				-- datos de la factura EE 
			, t.UltLista, st.ImS1Cod , st.ImS1Dsc
			, m.Consumo, st.Subtotal AS BaseEE, st.Cantitems
			, s.Fac1CtgCon, s.Fac1EttCod, s.Fac1Ctg
			, CASE WHEN s.Fac1Ctg IN (12, 16, 22, 28, 32, 36, 52, 56, 62) THEN 'NIVEL-2'
					WHEN s.Fac1Ctg IN (13,17,23,29,33,35,37,39,43,45,47,53,55,57,59,63,67,73,83,93,97,113) THEN 'NIVEL-3'
				ELSE 'NIVEL-1' END AS SEGMENTO
	-- datos de la factura No EE asociada a la EE 
			, CASE WHEN e.FrmCod=50 THEN (e.Fac7EneImp * -1) ELSE e.Fac7EneImp END AS FactEneElec -- Total Fact EE
			, CASE WHEN e.FrmCod=50 THEN (e.Fac7NoEImp * -1) ELSE e.Fac7NoEImp END AS FactNoElec  -- Total Fact No Electrica
			, CASE WHEN e.FrmCod=50 THEN (e.Fac7EneTot * -1) ELSE e.Fac7EneTot END AS Tot2Fact    -- Total ambas facturas
			, c2.UnaFac
			, CFCant, CFSubtot
			, it.ICT
			, e.FrmCod AS FrmNE, e.FactLet AS LetNE, e.FactPtoV AS PtoVNE, e.FactNro AS FactNroNE
			, e.Fac7NoEImp, e.Fac7EneImp, e.Fac7EneTot, e.Fac7EneSdo
			, s.Fac1MarEs, s.Fac1MarLis
		
			FROM [UPCN_COM_PROD].dbo.FACTUS s
				LEFT JOIN (-- consulta que agrupa por consumos por comprobante aunque haya 2 medidores
					SELECT m.SucCod, m.CliCod, m.SumNro, m.FactFec, m.FrmCod, m.FactLet, m.FactPtoV, m.FactNro, m.Fac1Srv
							, SUM(CASE WHEN m.FrmCod=50 THEN ((m.Fac1Cns+m.Fac1CnsP+m.Fac1CnsFP+m.Fac1CnsV)*m.Fac1Mlt)*-1
									ELSE ((m.Fac1Cns+m.Fac1CnsP+m.Fac1CnsFP+m.Fac1CnsV)*m.Fac1Mlt) END) AS Consumo
							FROM [UPCN_COM_PROD].dbo.FACTUM m WITH(NOLOCK)  -- CONSUMOS
						GROUP BY m.SucCod, m.CliCod, m.SumNro, m.FactFec, m.FrmCod, m.FactLet, m.FactPtoV, m.FactNro, m.Fac1Srv
					) m ON  (s.SucCod=m.SucCod AND s.CliCod=m.CliCod AND s.SumNro=m.SumNro AND s.FactFec=m.FactFec AND s.FrmCod=m.FrmCod AND s.FactLet=m.FactLet AND s.FactPtoV=m.FactPtoV AND s.FactNro=m.FactNro AND s.Fac1Srv=m.Fac1Srv) 

				LEFT JOIN (-- consulta que busca la ultima lista aplicada - no importa la cantidad de dias)
					SELECT t.SucCod, t.CliCod, t.SumNro, t.FactFec, t.FrmCod, t.FactLet, t.FactPtoV, t.FactNro, t.Fac1Srv, MAX(t.Fac5LstCod) AS UltLista
							FROM [UPCN_COM_PROD].dbo.FACTUT t WITH(NOLOCK)  -- CONSUMOS
						GROUP BY t.SucCod, t.CliCod, t.SumNro, t.FactFec, t.FrmCod, t.FactLet, t.FactPtoV, t.FactNro, t.Fac1Srv
					) t ON  (s.SucCod=t.SucCod AND s.CliCod=t.CliCod AND s.SumNro=t.SumNro AND s.FactFec=t.FactFec AND s.FrmCod=t.FrmCod AND s.FactLet=t.FactLet AND s.FactPtoV=t.FactPtoV AND s.FactNro=t.FactNro AND s.Fac1Srv=t.Fac1Srv) 

				LEFT JOIN ( -- consulta que agrupa por Subtotales de impresion 
					SELECT i.SucCod, i.CliCod, i.SumNro, i.FactFec, i.FrmCod, i.FactLet, i.FactPtoV, i.FactNro, s2.ImS1Cod, s1.ImS1Dsc
							, CASE WHEN i.FrmCod=50 THEN SUM(Fac2Imp1)*-1
									ELSE SUM(Fac2Imp1) END AS Subtotal
							, COUNT(*) AS Cantitems
						FROM [UPCN_COM_PROD].dbo.FACTUI i WITH(NOLOCK)  -- IMPORTES ITEMS
							JOIN [UPCN_COM_PROD].dbo.IMPSU2 S2 ON (i.SucCod=s2.ImS1Suc AND i.Fac2Cnp=s2.ImS2Cnp) -- Concepto <-> tabla subtotales
							JOIN [UPCN_COM_PROD].dbo.IMPSU1 S1 ON (s2.ImS1Suc=s1.ImS1Suc AND s2.ImS1Cod=s1.ImS1Cod AND s1.ImS1Cod=1) -- Tabla Subtotales 
			--	WHERE i.SucCod=1 AND i.CliCod=53935 AND i.FactFec>='20231101'
						GROUP BY SucCod, CliCod, SumNro, FactFec, FrmCod, FactLet, FactPtoV, FactNro, s2.ImS1Cod, s1.ImS1Dsc
					) st ON (s.SucCod=st.SucCod AND s.CliCod=st.CliCod AND s.SumNro=st.SumNro AND s.FactFec=st.FactFec AND s.FrmCod=st.FrmCod AND s.FactLet=st.FactLet AND s.FactPtoV=st.FactPtoV AND s.FactNro=st.FactNro) 


				LEFT JOIN ( -- consulta para CF cant y $
					SELECT i.SucCod, i.CliCod, i.SumNro, i.FactFec, i.FrmCod, i.FactLet, i.FactPtoV, i.FactNro
							, CASE WHEN i.FrmCod=50 THEN SUM(i.Fac2Imp1)*-1
									ELSE SUM(i.Fac2Imp1) END AS CFSubtot
							, COUNT(*) AS CFCant
						FROM [UPCN_COM_PROD].dbo.FACTUI i WITH(NOLOCK)
							WHERE i.Fac1Srv=1
							AND i.Fac2Itm IN (1021,1051,1121,1141,1201,1501,1901,2100,3100,4100,5100,5500) -- items de cargo fijo
							-- AND i.Fac2Cnp IN (12,14,62) -- conceptos de item de CF NO sirve para esta consulta varian los datos
						GROUP BY i.SucCod, i.CliCod, i.SumNro, i.FactFec, i.FrmCod, i.FactLet, i.FactPtoV, i.FactNro
					) cf ON (s.SucCod=cf.SucCod AND s.CliCod=cf.CliCod AND s.SumNro=cf.SumNro AND s.FactFec=cf.FactFec AND s.FrmCod=cf.FrmCod AND s.FactLet=cf.FactLet AND s.FactPtoV=cf.FactPtoV AND s.FactNro=cf.FactNro) 

				LEFT JOIN ( -- consulta obtener ICT
					SELECT i.SucCod, i.CliCod, i.SumNro, i.FactFec, i.FrmCod, i.FactLet, i.FactPtoV, i.FactNro
							, CASE WHEN i.FrmCod=50 THEN SUM(i.Fac2Imp1)*-1	ELSE SUM(i.Fac2Imp1) END AS ICT
						FROM [UPCN_COM_PROD].dbo.FACTUI i WITH(NOLOCK)
							WHERE i.Fac1Srv=1
							AND i.Fac2Itm BETWEEN 2007 AND 2014 -- items ICT 2011-2014 Sub-ICT 
							-- AND i.Fac2Cnp IN (12,14,62) -- conceptos de item de CF NO sirve para esta consulta varian los datos
						GROUP BY i.SucCod, i.CliCod, i.SumNro, i.FactFec, i.FrmCod, i.FactLet, i.FactPtoV, i.FactNro
					) it ON (s.SucCod=it.SucCod AND s.CliCod=it.CliCod AND s.SumNro=it.SumNro AND s.FactFec=it.FactFec AND s.FrmCod=it.FrmCod AND s.FactLet=it.FactLet AND s.FactPtoV=it.FactPtoV AND s.FactNro=it.FactNro) 

			JOIN (  -- consulta para contar las facturas
				SELECT c.SucCod, c.CliCod, c.SumNro, c.FactFec, c.FrmCod, c.FactLet, c.FactPtoV, c.FactNro, 1 AS UnaFac
					FROM [UPCN_COM_PROD].dbo.FACTUC c WITH(NOLOCK) 
				) c2 ON (s.SucCod=c2.SucCod AND s.CliCod=c2.CliCod AND s.SumNro=c2.SumNro AND s.FactFec=c2.FactFec AND s.FrmCod=c2.FrmCod AND s.FactLet=c2.FactLet AND s.FactPtoV=c2.FactPtoV AND s.FactNro=c2.FactNro) 

				LEFT JOIN [UPCN_COM_PROD].dbo.FACTUE e WITH(NOLOCK) ON (e.SucCod=s.SucCod AND e.CliCod=s.CliCod AND e.SumNro=s.SumNro AND e.FactFec=s.FactFec 
												AND e.Fac7EneFrm=s.FrmCod AND e.Fac7EneLet=s.FactLet AND e.Fac7EnePto=s.FactPtoV AND e.Fac7EneNro=s.FactNro AND s.Fac1Srv=1)

			WHERE s.SucCod=1 AND s.Fac1Srv=1 
--		AND s.CliCod=53935 AND s.FactFec >='20240101'

		) s2 ON (c.SucCod=s2.SucCod AND c.CliCod=s2.CliCod AND c.SumNro=s2.SumNro AND c.FactFec=s2.FactFec AND c.FrmCod=s2.FrmCod AND c.FactLet=s2.FactLet AND c.FactPtoV=s2.FactPtoV AND c.FactNro=s2.FactNro) 
		-- FIN DATOS-EE
-- FIN SUBCONSULTA DE ANALISIS DE EE

	WHERE c.SucCod=1 
			AND (c.Factquin<>9 AND c.FactAnu=0 AND c.FactObs=' ') -- Excluye las FC anuladas y las NC que anulan facturas
			AND c.FactFec >=  '01/' + RIGHT('00' + CAST(MONTH(GETDATE()) as varchar), 2) +'/'+ CAST((YEAR(GETDATE())-2) as varchar)

/*****************************************************************************************************************************/
/*****************************************************************************************************************************/
2024-09-27 13:08:14 - FunciÃ³n exportada: dbo.ReporteFacturacion

2024-09-27 13:08:14 - Cambios preparados para Git.
[main 4853659] ActualizaciÃ³n de vistas y funciones - 2024-09-27 13:08:14
 16 files changed, 526 insertions(+), 1 deletion(-)
 create mode 100644 SQL_Exports/Funciones/dbo_ReporteAnalisisDeuda.sql
 create mode 100644 SQL_Exports/Funciones/dbo_ReporteFacturacion.sql
2024-09-27 13:08:14 - Commit realizado con el mensaje: 'ActualizaciÃ³n de vistas y funciones - 2024-09-27 13:08:14'
Enumerating objects: 38, done.
Counting objects: 100% (38/38), done.
Delta compression using up to 28 threads
Compressing objects: 100% (21/21), done.
Writing objects: 100% (21/21), 7.85 KiB | 2.62 MiB/s, done.
Total 21 (delta 14), reused 0 (delta 0), pack-reused 0 (from 0)
remote: Resolving deltas: 100% (14/14), completed with 14 local objects.
To https://github.com/UPCN-Nestor/reportes-sql.git
   2e3386b..4853659  main -> main
2024-09-27 13:08:16 - Cambios subidos al repositorio remoto.
2024-09-27 13:08:16 - Proceso de exportaciÃ³n y Git finalizado.
La transcripción se ha detenido. El archivo de salida es C:\Repos\reportes-sql\transcript_log.txt
PS C:\Repos\reportes-sql> .\backup-scripts-vistas.ps1
**********************
Fin de la transcripción de Windows PowerShell
Hora de finalización: 20240927131326
**********************
